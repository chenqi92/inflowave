name: ç‰ˆæœ¬å‘å¸ƒæ„å»º

on:
  push:
    branches: [ main, master ]
    paths:
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  # ç‰ˆæœ¬æ£€æµ‹å·¥ä½œ
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
      tag_exists: ${{ steps.check.outputs.tag_exists }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘å‘å¸ƒ
        id: check
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITEE_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯package.jsonå˜æ›´è§¦å‘çš„
          if [ "${{ github.event_name }}" = "push" ]; then
            # æ£€æŸ¥package.jsonæ˜¯å¦åœ¨æœ¬æ¬¡æäº¤ä¸­è¢«ä¿®æ”¹
            if git diff --name-only HEAD~1 HEAD | grep -q "package.json"; then
              echo "ğŸ“ package.json åœ¨æœ¬æ¬¡æäº¤ä¸­è¢«ä¿®æ”¹"
          
              # æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦çœŸçš„å˜æ›´äº†
              PREV_VERSION=$(git show HEAD~1:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version" || echo "0.0.0")
              echo "ä¸Šä¸€ç‰ˆæœ¬: $PREV_VERSION"
              echo "å½“å‰ç‰ˆæœ¬: $VERSION"
          
              if [ "$VERSION" != "$PREV_VERSION" ]; then
                echo "âœ… ç‰ˆæœ¬ä» $PREV_VERSION å˜æ›´ä¸º $VERSION"
          
                # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
                if git tag -l | grep -q "^v$VERSION$"; then
                  echo "tag_exists=true" >> $GITEE_OUTPUT
                  echo "should_release=false" >> $GITEE_OUTPUT
                  echo "âš ï¸ æ ‡ç­¾ v$VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
                else
                  echo "tag_exists=false" >> $GITEE_OUTPUT
                  echo "should_release=true" >> $GITEE_OUTPUT
                  echo "ğŸš€ å°†ä¸º v$VERSION åˆ›å»ºå‘å¸ƒ"
                fi
              else
                echo "should_release=false" >> $GITEE_OUTPUT
                echo "â­ï¸ ç‰ˆæœ¬æœªå˜æ›´ï¼Œè·³è¿‡å‘å¸ƒ"
              fi
            else
              echo "should_release=false" >> $GITEE_OUTPUT
              echo "â­ï¸ package.json æœªä¿®æ”¹ï¼Œè·³è¿‡å‘å¸ƒ"
            fi
          else
            # æ‰‹åŠ¨è§¦å‘çš„æƒ…å†µ
            if git tag -l | grep -q "^v$VERSION$"; then
              echo "tag_exists=true" >> $GITEE_OUTPUT
              echo "should_release=false" >> $GITEE_OUTPUT
              echo "âš ï¸ æ ‡ç­¾ v$VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
            else
              echo "tag_exists=false" >> $GITEE_OUTPUT
              echo "should_release=true" >> $GITEE_OUTPUT
              echo "âœ… æ‰‹åŠ¨è§¦å‘ï¼šå°†ä¸º v$VERSION åˆ›å»ºå‘å¸ƒ"
            fi
          fi
        shell: bash

  # å‡†å¤‡å‘å¸ƒè¯´æ˜
  prepare-release-notes:
    runs-on: ubuntu-latest
    if: needs.detect-version.outputs.should_release == 'true'
    needs: detect-version
    outputs:
      release_body: ${{ steps.generate.outputs.release_body }}
    steps:
      - uses: actions/checkout@v3

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: generate
        run: |
          # ä½¿ç”¨å¤–éƒ¨è„šæœ¬ç”Ÿæˆrelease notes
          RELEASE_BODY=$(node scripts/generate-release-notes.cjs)
          
          # è¾“å‡ºåˆ° Gitee Actions
          {
            echo 'release_body<<EOF'
            echo "$RELEASE_BODY"
            echo 'EOF'
          } >> $GITEE_OUTPUT
        shell: bash

  # Windows æ„å»º
  build-windows:
    needs: [detect-version, prepare-release-notes]
    if: needs.detect-version.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: 'x86_64-pc-windows-msvc'
            arch: 'x64'
          - target: 'i686-pc-windows-msvc'
            arch: 'x86'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: è®¾ç½® Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          override: true

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: è®¾ç½® Windows æ„å»ºç¯å¢ƒ
        shell: pwsh
        run: |
          Write-Output "è®¾ç½® Windows æ„å»ºç¯å¢ƒ..."
          powershell -ExecutionPolicy Bypass -File scripts/setup-windows-build.ps1 -Force
          Write-Output "Windows æ„å»ºç¯å¢ƒè®¾ç½®å®Œæˆ"

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: npm ci

      - name: æ„å»ºåº”ç”¨
        shell: pwsh
        run: |
          Write-Output "å¼€å§‹æ„å»º Windows åº”ç”¨..."
          npm run tauri build -- --target ${{ matrix.target }}

      - name: æ„å»ºä¾¿æºç‰ˆ ZIP
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Output "æ„å»º Windows ä¾¿æºç‰ˆ ZIP..."
          powershell -ExecutionPolicy Bypass -File scripts/build-windows-portable-zip.ps1 -Target ${{ matrix.target }} -SkipBuild -Verbose

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: windows-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.exe
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.zip
          if-no-files-found: warn

  # Linux æ„å»º
  build-linux:
    needs: [detect-version, prepare-release-notes]
    if: needs.detect-version.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: 'x86_64-unknown-linux-gnu'
            arch: 'x64'
          - target: 'aarch64-unknown-linux-gnu'
            arch: 'arm64'
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3

      - name: å®‰è£…ä¾èµ– (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential curl wget file \
            libwebkit2gtk-4.0-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev \
            pkg-config libglib2.0-dev libssl-dev libxdo-dev patchelf

          # ARM64 äº¤å‰ç¼–è¯‘
          if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            sudo dpkg --add-architecture arm64
            sudo apt-get update
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          fi

      - name: è®¾ç½® Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          override: true

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: npm ci

      - name: æ„å»ºåº”ç”¨
        run: |
          echo "å¼€å§‹æ„å»º Linux åº”ç”¨..."
          npm run tauri build -- --target ${{ matrix.target }}
        env:
          PKG_CONFIG_ALLOW_CROSS: 1
          CC_aarch64_unknown_linux_gnu: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && 'aarch64-linux-gnu-gcc' || '' }}
          CXX_aarch64_unknown_linux_gnu: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && 'aarch64-linux-gnu-g++' || '' }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: linux-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.rpm
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage
          if-no-files-found: warn

  # macOS æ„å»º
  build-macos:
    needs: [detect-version, prepare-release-notes]
    if: needs.detect-version.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: 'x86_64-apple-darwin'
            arch: 'x64'
          - target: 'aarch64-apple-darwin'
            arch: 'arm64'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: è®¾ç½® Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          override: true

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: npm ci

      - name: æ„å»ºåº”ç”¨
        run: |
          echo "å¼€å§‹æ„å»º macOS åº”ç”¨..."
          npm run tauri build -- --target ${{ matrix.target }}
        env:
          MACOSX_DEPLOYMENT_TARGET: '10.15'

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: macos-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.app
          if-no-files-found: warn

  # åˆ›å»ºå‘å¸ƒ
  create-release:
    needs: [detect-version, prepare-release-notes, build-windows, build-linux, build-macos]
    if: needs.detect-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: åˆ›å»º Git æ ‡ç­¾
        run: |
          git config user.name "Gitee Actions"
          git config user.email "actions@gitee.com"
          git tag -a "v${{ needs.detect-version.outputs.version }}" -m "Release v${{ needs.detect-version.outputs.version }}"
          git push origin "v${{ needs.detect-version.outputs.version }}"
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}

      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files

          # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©åˆ°å‘å¸ƒç›®å½•
          find artifacts -type f \( -name "*.msi" -o -name "*.exe" -o -name "*.zip" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.dmg" \) -exec cp {} release-files/ \;

          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
          ls -lh release-files/

      - name: åˆ›å»º Gitee Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        with:
          tag_name: v${{ needs.detect-version.outputs.version }}
          release_name: InfloWave v${{ needs.detect-version.outputs.version }}
          body: ${{ needs.prepare-release-notes.outputs.release_body }}
          draft: false
          prerelease: false

      - name: ä¸Šä¼ å‘å¸ƒæ–‡ä»¶
        run: |
          # ä½¿ç”¨ Gitee API ä¸Šä¼ æ–‡ä»¶
          for file in release-files/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "ä¸Šä¼ : $filename"

              # è¿™é‡Œéœ€è¦ä½¿ç”¨ Gitee API ä¸Šä¼ æ–‡ä»¶
              # æ³¨æ„ï¼šGitee çš„ API å¯èƒ½ä¸ GitHub ä¸åŒï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITEE_TOKEN }}" \
                -H "Content-Type: multipart/form-data" \
                -F "file=@$file" \
                "https://gitee.com/api/v5/repos/${{ github.repository }}/releases/${{ steps.create_release.outputs.id }}/attach_files"
            fi
          done
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}

