# InfloWave v0.8.8 å‘å¸ƒè¯´æ˜Ž

## ðŸš€ S3 æµè§ˆå™¨è§†é¢‘æ’­æ”¾ä¸Žä¸´æ—¶æ–‡ä»¶ç®¡ç†

æœ¬ç‰ˆæœ¬ä¸“æ³¨äºŽä¿®å¤ S3 æµè§ˆå™¨ä¸­è§†é¢‘æ–‡ä»¶æ— æ³•æ’­æ”¾çš„å…³é”®é—®é¢˜ï¼Œå¹¶æ–°å¢žæ™ºèƒ½ä¸´æ—¶æ–‡ä»¶æ¸…ç†æœºåˆ¶ï¼Œé˜²æ­¢ç£ç›˜ç©ºé—´ç§¯åŽ‹ã€‚

---

## âœ¨ é‡è¦ç‰¹æ€§

### ðŸŽ¬ S3 è§†é¢‘æ’­æ”¾ä¿®å¤

#### WebKit åª’ä½“åè®®å…¼å®¹æ€§é—®é¢˜
- **ä¿®å¤** Tauri WebKit ä¸­è§†é¢‘å…ƒç´ æ— æ³•æ’­æ”¾çš„é—®é¢˜ï¼ˆé”™è¯¯ä»£ç  4: MEDIA_ERR_SRC_NOT_SUPPORTEDï¼‰
- **ä¿®å¤** Blob URLã€Asset Protocolã€è‡ªå®šä¹‰ URI åè®®åœ¨ WebKit ä¸­ä¸è¢«è§†é¢‘å…ƒç´ æ”¯æŒçš„é—®é¢˜
- **å®žçŽ°** åŸºäºŽ axum çš„æœ¬åœ° HTTP è§†é¢‘æœåŠ¡å™¨ï¼Œæä¾› WebKit å…¼å®¹çš„è§†é¢‘æµ

#### æœ¬åœ° HTTP è§†é¢‘æœåŠ¡å™¨
- **æ–°å¢ž** ç‹¬ç«‹çš„ HTTP è§†é¢‘æœåŠ¡å™¨æ¨¡å—ï¼ˆç«¯å£èŒƒå›´ 14280-14300ï¼‰
- **æ–°å¢ž** è‡ªåŠ¨ç«¯å£åˆ†é…æœºåˆ¶ï¼Œé¿å…ç«¯å£å†²çª
- **æ–°å¢ž** å®‰å…¨è·¯å¾„éªŒè¯ï¼Œä»…å…è®¸è®¿é—®åº”ç”¨ç¼“å­˜ç›®å½•å†…çš„æ–‡ä»¶
- **æ–°å¢ž** ç›®å½•éåŽ†æ”»å‡»é˜²æŠ¤ï¼ˆ`..` æ£€æµ‹ï¼‰
- **æ”¯æŒ** å¤šç§è§†é¢‘æ ¼å¼ï¼ˆMP4ã€WebMã€OGGã€MOVã€AVIã€MKVã€M4Vï¼‰

### ðŸ§¹ æ™ºèƒ½ä¸´æ—¶æ–‡ä»¶æ¸…ç†

#### å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†
- **æ–°å¢ž** åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¸´æ—¶è§†é¢‘æ–‡ä»¶
- **æ–°å¢ž** åŸºäºŽæ–‡ä»¶å¹´é¾„çš„æ¸…ç†ç­–ç•¥ï¼ˆè¶…è¿‡ 24 å°æ—¶è‡ªåŠ¨åˆ é™¤ï¼‰
- **æ–°å¢ž** åŸºäºŽæ€»å¤§å°çš„æ¸…ç†ç­–ç•¥ï¼ˆè¶…è¿‡ 500MB æ—¶æ¸…ç†åˆ° 400MBï¼‰
- **ä¼˜åŒ–** æŒ‰ä¿®æ”¹æ—¶é—´æŽ’åºï¼Œä¼˜å…ˆåˆ é™¤æœ€æ—§æ–‡ä»¶

#### ç£ç›˜ç©ºé—´ä¿æŠ¤
- **é˜²æ­¢** ä¸´æ—¶è§†é¢‘æ–‡ä»¶æ— é™ç§¯ç´¯å¯¼è‡´ç£ç›˜ç©ºé—´è€—å°½
- **è§£å†³** åº”ç”¨é‡å¯åŽå†…å­˜ç¼“å­˜ä¸¢å¤±å¯¼è‡´çš„å­¤å„¿æ–‡ä»¶é—®é¢˜
- **æ—¥å¿—** è¯¦ç»†è®°å½•æ¸…ç†ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ–‡ä»¶æ•°é‡ã€é‡Šæ”¾ç©ºé—´ã€å‰©ä½™ç©ºé—´ï¼‰

---

## ðŸ› ï¸ ä¿®å¤ä¸Žç»†èŠ‚ä¼˜åŒ–

### æ ¸å¿ƒä¿®å¤
- ä¿®å¤ S3 æµè§ˆå™¨ä¸­è§†é¢‘æ— æ³•æ’­æ”¾çš„é—®é¢˜ï¼ˆMEDIA_ERR_SRC_NOT_SUPPORTEDï¼‰
- ä¿®å¤ Blob URL åœ¨ Tauri WebKit ä¸­ä¸æ”¯æŒ video å…ƒç´ çš„é—®é¢˜
- ä¿®å¤ä¸´æ—¶æ–‡ä»¶ç´¯ç§¯å¯¼è‡´çš„ç£ç›˜ç©ºé—´æµªè´¹
- ä¿®å¤ axum 0.8 è·¯ç”±æ ¼å¼å˜æ›´å¯¼è‡´çš„å¯åŠ¨ panic

### è§†é¢‘æœåŠ¡å™¨
- æ–°å¢ž `video_server.rs` æ¨¡å—ï¼Œå®žçŽ°å®Œæ•´çš„ HTTP è§†é¢‘æœåŠ¡
- æ·»åŠ  CORS æ”¯æŒï¼Œå…è®¸å‰ç«¯è·¨åŸŸè®¿é—®
- å®žçŽ° Range è¯·æ±‚å¤´æ”¯æŒï¼Œå…è®¸è§†é¢‘æ‹–åŠ¨å’Œåˆ†æ®µåŠ è½½
- è‡ªåŠ¨ MIME ç±»åž‹æ£€æµ‹ï¼Œæ ¹æ®æ–‡ä»¶æ‰©å±•åè¿”å›žæ­£ç¡®çš„ Content-Type
- ä¼˜é›…å…³é—­æœºåˆ¶ï¼Œæ”¯æŒæœåŠ¡å™¨åœæ­¢å’Œé‡å¯

### ä¸´æ—¶æ–‡ä»¶ç®¡ç†
- æ–°å¢ž `cleanup_temp_video_files()` å‡½æ•°
- æ‰«æ `~/Library/Caches/inflowave/video_previews/` ç›®å½•
- åŒé‡æ¸…ç†ç­–ç•¥ï¼šæ—¶é—´è¿‡æœŸ + ç©ºé—´è¶…é™
- æ™ºèƒ½è·³è¿‡ä¸å­˜åœ¨çš„ç›®å½•ï¼Œé¿å…å¯åŠ¨é”™è¯¯

### å‰ç«¯ä¼˜åŒ–
- ä¿®æ”¹ `previewHandler.ts`ï¼Œä½¿ç”¨ HTTP URL æ›¿ä»£ Blob URL
- ä¿ç•™çŽ°æœ‰çš„ä¸´æ—¶æ–‡ä»¶ç¼“å­˜ç®¡ç†å™¨ï¼ˆ`tempFileCache.ts`ï¼‰
- ä¼˜åŒ– Blob URL æ¸…ç†é€»è¾‘ï¼Œé¿å…è¿‡æ—©é‡Šæ”¾
- æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºŽé—®é¢˜æŽ’æŸ¥

---

## ðŸ“ æŠ€æœ¯æ”¹è¿›

### åŽç«¯ (Rust)
- `video_server.rs`: æ–°å¢žå®Œæ•´çš„ HTTP è§†é¢‘æœåŠ¡å™¨å®žçŽ°
  - `start_video_server()`: å¯åŠ¨æœåŠ¡å™¨å¹¶è¿”å›žç«¯å£å·
  - `stop_video_server()`: ä¼˜é›…å…³é—­æœåŠ¡å™¨
  - `get_video_server_port()`: èŽ·å–å½“å‰è¿è¡Œç«¯å£
  - `cleanup_temp_video_files()`: æ¸…ç†è¿‡æœŸä¸´æ—¶æ–‡ä»¶
  - `serve_video()`: å¤„ç†è§†é¢‘è¯·æ±‚ï¼ŒåŒ…å«å®‰å…¨æ£€æŸ¥
- `services/mod.rs`: å¯¼å‡ºè§†é¢‘æœåŠ¡å™¨ç›¸å…³å‡½æ•°
- `commands/system.rs`: æ–°å¢ž `start_video_server` å’Œ `get_video_server_port` å‘½ä»¤
- `main.rs`: åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ä¸´æ—¶æ–‡ä»¶æ¸…ç†
- `Cargo.toml`: æ·»åŠ  HTTP æœåŠ¡å™¨ä¾èµ–ï¼ˆaxumã€towerã€tower-httpï¼‰

### å‰ç«¯ (TypeScript)
- `previewHandler.ts`:
  - ä¿®æ”¹è§†é¢‘é¢„è§ˆç”Ÿæˆé€»è¾‘ï¼Œä½¿ç”¨ HTTP URL
  - è°ƒç”¨ `start_video_server` èŽ·å–æœåŠ¡å™¨ç«¯å£
  - URL ç¼–ç ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
- `tempFileCache.ts`: ä¿ç•™çŽ°æœ‰ç¼“å­˜ç®¡ç†é€»è¾‘
- `index.tsx`: ä¼˜åŒ– Blob URL æ¸…ç†æ—¶æœº

### é…ç½®æ–‡ä»¶
- `tauri.conf.json`: æ›´æ–° CSP ç­–ç•¥
  - `media-src` æ·»åŠ  `http://127.0.0.1:*`ï¼Œå…è®¸æœ¬åœ° HTTP è§†é¢‘æº
  - ä¿æŒå…¶ä»–å®‰å…¨ç­–ç•¥ä¸å˜

---

## ðŸ” æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ Blob URLï¼Ÿ

| æ–¹æ¡ˆ | çŠ¶æ€ | åŽŸå›  |
|------|------|------|
| Blob URL (`blob://...`) | âŒ å¤±è´¥ | Tauri WebKit ä¸æ”¯æŒ blob URL ç”¨äºŽ video å…ƒç´  |
| Asset Protocol (`asset://localhost/...`) | âŒ å¤±è´¥ | WebKit ä¸è¯†åˆ« asset åè®®ä½œä¸ºåª’ä½“æº |
| Custom URI Scheme (`video-stream://...`) | âŒ å¤±è´¥ | è‡ªå®šä¹‰åè®®æœªè¢« WebKit è§†é¢‘å…ƒç´ æŽ¥å— |
| Local HTTP Server (`http://127.0.0.1:*`) | âœ… æˆåŠŸ | æ ‡å‡† HTTP åè®®ï¼Œæ‰€æœ‰æµè§ˆå™¨å¼•æ“Žæ”¯æŒ |

### æ¸…ç†ç­–ç•¥è¯¦è§£

```
å¯åŠ¨æ—¶æ¸…ç†é€»è¾‘ï¼š
1. æ‰«æä¸´æ—¶ç›®å½•ï¼ˆ~/Library/Caches/inflowave/video_previews/ï¼‰
2. æ”¶é›†æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯ï¼ˆè·¯å¾„ã€ä¿®æ”¹æ—¶é—´ã€å¤§å°ï¼‰
3. æŒ‰ä¿®æ”¹æ—¶é—´æŽ’åºï¼ˆæœ€æ—§çš„åœ¨å‰ï¼‰
4. ç¬¬ä¸€è½®ï¼šåˆ é™¤è¶…è¿‡ 24 å°æ—¶çš„æ–‡ä»¶
5. ç¬¬äºŒè½®ï¼šå¦‚æžœæ€»å¤§å° > 500MBï¼Œç»§ç»­åˆ é™¤æœ€æ—§æ–‡ä»¶ç›´åˆ° <= 400MB
6. è®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼ˆåˆ é™¤æ•°é‡ã€é‡Šæ”¾ç©ºé—´ã€å‰©ä½™ç©ºé—´ï¼‰
```

### å®‰å…¨æœºåˆ¶

1. **è·¯å¾„éªŒè¯**: åªå…è®¸è®¿é—® `$APPCACHE/inflowave/` ç›®å½•å†…çš„æ–‡ä»¶
2. **ç›®å½•éåŽ†é˜²æŠ¤**: æ£€æµ‹å¹¶æ‹’ç»åŒ…å« `..` çš„è·¯å¾„
3. **ç«¯å£éš”ç¦»**: ä»…ç»‘å®š 127.0.0.1ï¼Œä¸å¯¹å¤–ç½‘å¼€æ”¾
4. **CORS ç­–ç•¥**: å…è®¸æœ¬åœ°å‰ç«¯è®¿é—®ï¼Œå…¶ä»–æºè¢«é˜»æ­¢
5. **æ–‡ä»¶å­˜åœ¨æ£€æŸ¥**: è¿”å›ž 404 è€Œéžå†…éƒ¨é”™è¯¯ï¼Œé¿å…ä¿¡æ¯æ³„éœ²

---

## ðŸ› ç¼–è¯‘é—®é¢˜ä¿®å¤

### Axum 0.8 è·¯ç”±æ ¼å¼
- **é—®é¢˜**: `Path segments must not start with *`
- **åŽŸå› **: axum 0.8 å°† wildcard æ ¼å¼ä»Ž `/*path` æ”¹ä¸º `{*path}`
- **ä¿®å¤**: æ›´æ–°è·¯ç”±å®šä¹‰ä¸º `/video/{*path}`

### ç¼–è¯‘è­¦å‘Šæ¸…ç†
- **ä¿®å¤** `unused_doc_comments` è­¦å‘Šï¼ˆlazy_static ä¸Šçš„æ–‡æ¡£æ³¨é‡Šï¼‰
- **ä¿®å¤** `unused_imports` è­¦å‘Šï¼ˆç§»é™¤æœªä½¿ç”¨çš„ `stop_video_server`ï¼‰

---

## ðŸ“Š æ€§èƒ½ä¸Žèµ„æº

### ç£ç›˜ç©ºé—´
- **ä¸´æ—¶æ–‡ä»¶ä¸Šé™**: 500MBï¼ˆè¶…é™è‡ªåŠ¨æ¸…ç†åˆ° 400MBï¼‰
- **æ–‡ä»¶ä¿ç•™æ—¶é—´**: 24 å°æ—¶ï¼ˆè¿‡æœŸè‡ªåŠ¨åˆ é™¤ï¼‰
- **å¯åŠ¨æ—¶æ¸…ç†**: è‡ªåŠ¨æ‰«æå¹¶æ¸…ç†ä¸Šæ¬¡è¿è¡Œçš„æ®‹ç•™æ–‡ä»¶

### æœåŠ¡å™¨èµ„æº
- **ç«¯å£èŒƒå›´**: 14280-14300ï¼ˆè‡ªåŠ¨é€‰æ‹©å¯ç”¨ç«¯å£ï¼‰
- **å†…å­˜å ç”¨**: æœ€å°åŒ–ï¼ˆä½¿ç”¨ tokio å¼‚æ­¥è¿è¡Œæ—¶ï¼‰
- **å¹¶å‘æ”¯æŒ**: åŸºäºŽ axumï¼Œæ”¯æŒå¤šè§†é¢‘åŒæ—¶æ’­æ”¾

### è§†é¢‘æ”¯æŒ
- **æ ¼å¼æ”¯æŒ**: MP4ã€WebMã€OGGã€MOVã€AVIã€MKVã€M4V
- **Range è¯·æ±‚**: æ”¯æŒï¼Œå…è®¸æ‹–åŠ¨å’Œåˆ†æ®µåŠ è½½
- **ç¼“å­˜ç­–ç•¥**: `no-cache`ï¼Œç¡®ä¿å§‹ç»ˆèŽ·å–æœ€æ–°å†…å®¹

---

## ðŸ” å‡çº§å»ºè®®

1. **S3 å¯¹è±¡å­˜å‚¨ç”¨æˆ·**ï¼š
   - å¦‚é‡åˆ°è§†é¢‘æ— æ³•æ’­æ”¾ï¼Œè¯·å‡çº§åˆ°æ­¤ç‰ˆæœ¬
   - è§†é¢‘æ’­æ”¾çŽ°åœ¨å®Œå…¨æ”¯æŒ Tauri æ¡Œé¢çŽ¯å¢ƒ
   - æ”¯æŒå¤šç§è§†é¢‘æ ¼å¼å’Œå¤§æ–‡ä»¶æ’­æ”¾

2. **æ‰€æœ‰ç”¨æˆ·**ï¼š
   - ä¸´æ—¶æ–‡ä»¶å°†è‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€æ‰‹åŠ¨åˆ é™¤
   - ç£ç›˜ç©ºé—´å ç”¨å°†è¢«æŽ§åˆ¶åœ¨åˆç†èŒƒå›´
   - é¦–æ¬¡å¯åŠ¨åŽä¼šæ¸…ç†æ—§ç‰ˆæœ¬æ®‹ç•™çš„ä¸´æ—¶æ–‡ä»¶

3. **å¼€å‘è€…**ï¼š
   - ä½¿ç”¨ HTTP åè®®æ˜¯æ¡Œé¢åº”ç”¨ä¸­åª’ä½“æ’­æ”¾çš„æœ€ä½³å®žè·µ
   - é¿å…ä½¿ç”¨ blob URLã€data URL ç­‰éžæ ‡å‡†åè®®
   - ä¸´æ—¶æ–‡ä»¶ç®¡ç†éœ€è¦è€ƒè™‘åº”ç”¨é‡å¯åŽçš„æ¸…ç†

---

## ðŸŽ¯ å·²çŸ¥é™åˆ¶

1. **è§†é¢‘æœåŠ¡å™¨**ï¼š
   - ä»…æ”¯æŒæœ¬åœ°è®¿é—®ï¼ˆ127.0.0.1ï¼‰ï¼Œä¸å¯¹å±€åŸŸç½‘å¼€æ”¾
   - ç«¯å£èŒƒå›´å›ºå®šï¼ˆ14280-14300ï¼‰ï¼Œè¶…å‡ºèŒƒå›´å¯åŠ¨å¤±è´¥
   - ä¸æ”¯æŒ HTTPSï¼ˆæœ¬åœ°åº”ç”¨æ— éœ€åŠ å¯†ï¼‰

2. **ä¸´æ—¶æ–‡ä»¶**ï¼š
   - æ¸…ç†ä»…åœ¨åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œï¼ˆä¸å®žæ—¶æ¸…ç†ï¼‰
   - å‰ç«¯å†…å­˜ç¼“å­˜åœ¨åº”ç”¨é‡å¯åŽä¸¢å¤±ï¼ˆæ— æŒä¹…åŒ–ï¼‰
   - å¤šå®žä¾‹åŒæ—¶è¿è¡Œå¯èƒ½å¯¼è‡´æ–‡ä»¶ç«žäº‰ï¼ˆå·²åšé˜²æŠ¤ï¼‰

---

## ðŸ™ è‡´è°¢

æ„Ÿè°¢åé¦ˆè§†é¢‘æ’­æ”¾é—®é¢˜çš„ç”¨æˆ·ï¼Œè¿™å¸®åŠ©æˆ‘ä»¬æ·±å…¥ç†è§£äº† Tauri WebKit çš„åª’ä½“åè®®é™åˆ¶ï¼Œå¹¶æ‰¾åˆ°äº†æœ€ä½³è§£å†³æ–¹æ¡ˆï¼

æ¬¢è¿Žä½“éªŒ InfloWave v0.8.8ï¼Œå¦‚é‡é—®é¢˜æ¬¢è¿Žåœ¨ [GitHub Issues](https://github.com/chenqi92/inflowave/issues) ä¸­åé¦ˆï¼
