# InfloWave v0.8.6 发布说明

## 🚀 S3 对象存储与日志系统修复

本版本专注于 S3 对象存储功能的完善和日志系统的稳定性提升，修复了自定义域名预签名 URL 无法访问的关键问题，并优化了应用启动时的日志处理。

---

## ✨ 重要特性

### 🗄️ S3 对象存储增强

#### 预签名 URL 自定义域名修复
- **修复** 使用自定义域名生成的分享链接无法访问的问题
- **修复** 签名基于内网端点计算导致的 `SignatureDoesNotMatch` 错误
- **新增** 为预签名 URL 创建独立的临时客户端，使用自定义域名作为签名端点
- **优化** 自定义域名场景下强制使用 path-style URL 格式

#### 技术细节
- 旧逻辑：使用内网端点生成签名后简单替换域名（签名失效）
- 新逻辑：直接使用自定义域名作为端点生成签名（签名匹配）

### 🛡️ 日志系统稳定性

#### 文件不存在问题修复
- **修复** 打包后应用启动时因日志文件不存在导致的持续报错
- **修复** 相对路径在生产环境中无法正确解析的问题
- **新增** `get_file_info_env` 环境感知命令，自动解析开发/生产环境路径
- **优化** 文件不存在时返回默认值而非错误，保证应用正常启动

#### 时区问题修复
- **修复** 日志时间戳显示 UTC 时间导致的时区偏差
- **新增** `formatLocalTimestamp()` 方法，显示本地时间 + 时区信息
- **改进** 时间格式从 `2025-11-27T08:23:42.230Z` 改为 `2025-11-27T16:23:42.230+08:00`

---

## 🛠️ 修复与细节优化

### 核心修复
- 修复 S3 自定义域名预签名 URL 签名不匹配问题
- 修复日志系统在生产环境中持续报错 `文件不存在: logs/frontend.log`
- 修复日志时间戳与本地时间不一致的问题
- 修复 Radix UI DialogContent 无障碍警告 `Missing Description`

### S3 对象存储
- 新增 `create_presign_client` 方法，创建使用自定义域名的临时 S3 客户端
- 优化 `generate_presigned_url` 方法，根据是否配置自定义域名选择正确的客户端
- 强制自定义域名场景使用 path-style（`https://domain.com/bucket/key`）
- 支持反向代理/CDN 等常见自定义域名配置

### 日志系统
- 新增 `get_file_info_env` 后端命令，支持环境感知的文件信息获取
- 优化 `FileOperations.getFileInfo()` 使用新的环境感知命令
- 添加 `formatLocalTimestamp()` 方法到 `logger.ts` 和 `consoleLogger.ts`
- 修改会话开始标记、日志条目、轮转文件名均使用本地时间

### UI 优化
- 修复 `DialogContent` 组件的无障碍警告
- 设置默认 `aria-describedby={undefined}` 消除 Radix UI 警告

---

## 📁 技术改进

### 前端
- `fileOperations.ts`: 使用 `get_file_info_env` 替代 `get_file_info`
- `logger.ts`: 新增 `formatLocalTimestamp()`，修复时区问题
- `consoleLogger.ts`: 同步添加本地时间格式化支持
- `dialog.tsx`: 添加 `aria-describedby={undefined}` 消除警告
- `tauri.ts`: 添加 `FileInfoRust` 类型定义

### 后端 (Rust)
- `s3_client.rs`: 新增 `create_presign_client()` 方法
- `s3_client.rs`: 重写 `generate_presigned_url()`，支持自定义域名签名
- `system.rs`: 新增 `get_file_info_env` 环境感知命令
- `main.rs`: 注册新的 `get_file_info_env` 命令

---

## 🔍 升级建议

1. **S3 对象存储用户**：
   - 如使用自定义域名分享文件，请升级到此版本
   - 确保自定义域名配置正确（反向代理指向 S3 服务）
   - 生成的分享链接现在可以正常访问

2. **所有用户**：
   - 如遇到启动时日志报错，请升级到此版本
   - 日志时间现在显示本地时间，更易阅读

---

## 📋 URL 格式说明

### 修复前（virtual-hosted-style，签名失效）
```
https://bucket.custom-domain.com/path/to/file.png?X-Amz-Signature=...
```

### 修复后（path-style，签名有效）
```
https://custom-domain.com/bucket/path/to/file.png?X-Amz-Signature=...
```

---

## 🙏 致谢

感谢反馈 S3 自定义域名分享问题的用户，这帮助我们完善了对象存储功能！

欢迎体验 InfloWave v0.8.6，如遇问题欢迎在 [GitHub Issues](https://github.com/chenqi92/inflowave/issues) 中反馈！
