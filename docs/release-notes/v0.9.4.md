# InfloWave v0.9.4 发布说明

## 🚀 编辑器生产环境样式修复

本版本彻底解决了 SQL 代码编辑器在打包发布后出现布局错位、语法高亮颜色丢失的关键问题，同时清理了冗余代码并优化了 CI/CD 工作流。

---

## ✨ 重要特性

### 🎨 CodeMirror 6 生产环境样式修复

#### 根因修复
- **修复** 打包后 SQL 编辑器语法高亮颜色完全丢失的问题
- **修复** 编辑器在生产环境中布局错位的问题
- **删除** `index.css` 中 3 条覆盖 `style-mod` 动态样式的有害 CSS 规则
- **解决** CSS 加载顺序差异导致的开发/生产环境表现不一致

#### 技术细节
CodeMirror 6 通过 `style-mod` 库在运行时将 CSS 注入到 `<head>` 的第一个子元素位置。在开发模式下 Vite 的 HMR 样式注入顺序与 `style-mod` 不冲突，但生产打包后静态 CSS 合并为单一文件，以更高优先级覆盖了动态注入的语法高亮样式。

| 有害规则 | 影响 |
|---------|------|
| `.dark .cm-editor .cm-content [class*="cm-"]` | 通配选择器强制所有 CodeMirror 元素为同一颜色 |
| `:root:not(.dark) .cm-editor .cm-content [class*="cm-"]` | 同上，亮色主题版本 |
| `.cm-editor .cm-line span { color: inherit }` | 强制所有 span 继承父级颜色，完全抹杀语法高亮 |

#### 编辑器代码清理
- **移除** `preset.ts` 中与 `theme.ts` 冲突的 `defaultHighlightStyle` fallback
- **移除** `CodeMirrorEditor.tsx` 中的临时诊断调试代码（约 50 行）
- **统一** 语法高亮完全由 `theme.ts` 的 `createSyntaxTheme` 提供

### ⚙️ CI/CD 工作流优化

- **重构** 清理工作流以支持多任务配置
- **新增** 自动清理旧工作流运行的 GitHub Actions 配置
- **优化** 工作流维护成本，减少冗余配置

---

## 🛠️ 修复与细节优化

### 核心修复
- 修复 `style-mod` 动态样式被静态 CSS 覆盖导致语法高亮失效
- 修复 `defaultHighlightStyle` 与自定义 `createSyntaxTheme` 同时设置 `fallback: true` 导致的高亮竞争
- 清理编辑器组件中遗留的诊断日志代码

### 样式优化
- 优化 CodeMirror 6 自动完成组件样式
- 完善编辑器在亮色/暗色主题间切换的表现

---

## 📁 技术改进

### 前端 (TypeScript)
- `src/styles/index.css`: 删除覆盖 `style-mod` 的 3 条 CSS 规则，替换为防护注释
- `src/editor/cm6/preset.ts`: 移除 `syntaxHighlighting(defaultHighlightStyle)` 冗余 fallback
- `src/editor/cm6/CodeMirrorEditor.tsx`: 清理 `[CM6-Diag]` 诊断代码块

### 工作流 (GitHub Actions)
- 重构工作流清理配置
- 新增旧工作流运行清理自动化

---

## 🔍 升级建议

1. **所有用户**：
   - 打包后的 SQL 编辑器现在能正确显示语法高亮颜色
   - 编辑器布局不再错位，与开发环境表现一致
   - 亮色/暗色主题切换后颜色正确更新

2. **开发者**：
   - `style-mod` 会将样式插入 `<head>` 头部，编写 CSS 时避免使用高特异度选择器覆盖 CodeMirror 的类名
   - 语法高亮统一由 `theme.ts` 管理，不要在其他地方添加 `defaultHighlightStyle` fallback

---

## 🙏 致谢

感谢所有反馈编辑器样式问题的用户，帮助我们定位了这个仅在生产环境出现的问题！

欢迎体验 InfloWave v0.9.4，如遇问题欢迎在 [GitHub Issues](https://github.com/chenqi92/inflowave/issues) 中反馈！
