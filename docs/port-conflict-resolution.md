# 端口冲突解决方案

## 问题描述

这是一个前后端分离项目，最终打包为桌面端应用。由于后端采用的端口（1422）是较常用的端口，如果启动软件时该端口被占用，会导致软件启动成功但实际无法使用。

## 解决方案概述

我们实现了一个智能端口管理系统，包含以下功能：

1. **启动时端口冲突检测**
2. **自动端口分配**
3. **端口健康监控**
4. **动态配置更新**

## 实现细节

### 1. 后端端口管理 (Rust)

#### 端口管理器服务
- **位置**: `src-tauri/src/services/port_manager.rs`
- **功能**: 
  - 端口可用性检测
  - 自动端口分配
  - 端口健康检查
  - 端口冲突解决

#### 主要配置
```rust
// 默认端口配置
PortConfig {
    preferred_port: 1422,        // 首选端口
    port_range: (1422, 1500),   // 端口搜索范围
    max_retries: 10,            // 最大重试次数
    health_check_interval: 30s   // 健康检查间隔
}
```

#### 启动时端口处理
- **位置**: `src-tauri/src/main.rs`
- **流程**:
  1. 检查默认端口 1422 是否可用
  2. 如果可用，直接分配
  3. 如果不可用，在范围内查找可用端口
  4. 启动健康检查循环

### 2. 前端端口监控 (TypeScript)

#### 端口发现服务
- **位置**: `src/services/portDiscovery.ts`
- **功能**:
  - 与后端端口管理器通信
  - 端口状态监控
  - 事件处理

#### React Hook
- **位置**: `src/hooks/usePortDiscovery.ts`
- **功能**:
  - 端口状态管理
  - 自动重连机制
  - 用户界面更新

#### 端口状态组件
- **位置**: `src/components/PortStatus.tsx`
- **功能**:
  - 实时显示端口状态
  - 端口冲突处理按钮
  - 健康检查控制

### 3. 智能启动脚本

#### 启动脚本
- **位置**: `scripts/start-with-port-check.js`
- **功能**:
  - 启动前端口可用性检查
  - 动态更新配置文件
  - 环境变量设置

#### 使用方法
```bash
# 使用智能启动（推荐）
npm run tauri:dev:safe

# 传统启动
npm run tauri:dev
```

## 新增 Tauri 命令

以下命令可在前端调用：

- `ensureFrontendPortAvailable()` - 确保前端端口可用
- `getFrontendPort()` - 获取当前前端端口
- `isPortAvailable(port)` - 检查端口是否可用
- `allocatePort(serviceName)` - 为服务分配端口
- `releasePort(serviceName)` - 释放服务端口
- `checkPortConflicts()` - 检查端口冲突
- `getPortStats()` - 获取端口统计信息

## 配置文件更新

### 自动更新的配置文件

1. **tauri.conf.json** - Tauri 开发服务器 URL
2. **vite.config.ts** - Vite 开发服务器端口

### 环境变量
- `PORT` - 服务器端口
- `VITE_PORT` - Vite 端口
- `VITE_DEV_SERVER_PORT` - Vite 开发服务器端口

## 用户体验

### 端口冲突处理流程
1. **自动检测**: 启动时自动检测端口冲突
2. **智能分配**: 自动分配可用端口
3. **用户通知**: 通过 Toast 通知用户端口变更
4. **状态显示**: 实时显示端口状态和健康状况

### 错误恢复
- 端口冲突自动重新分配
- 健康检查失败自动恢复
- 提供手动解决冲突的按钮

## 监控和调试

### 日志输出
- 启动时端口检查日志
- 端口分配和释放日志
- 健康检查结果日志
- 端口冲突解决日志

### 调试工具
- 端口状态面板
- 端口统计信息
- 手动端口操作按钮

## 部署注意事项

### 开发环境
- 使用 `npm run tauri:dev:safe` 启动
- 端口冲突会自动解决
- 配置文件会自动更新

### 生产环境
- 打包后的应用会自动处理端口冲突
- 用户无需手动配置
- 提供端口状态查看界面

## 故障排除

### 常见问题

1. **端口仍被占用**
   - 检查是否有其他服务占用端口范围
   - 尝试扩大端口搜索范围

2. **配置文件更新失败**
   - 检查文件权限
   - 手动更新配置文件

3. **前端无法连接**
   - 检查端口管理器是否正确初始化
   - 查看端口状态面板

### 调试命令
```bash
# 检查端口占用
lsof -i :1422

# 查看进程
ps aux | grep 1422

# 手动测试端口
telnet localhost 1422
```

## 总结

这个端口冲突解决方案提供了：
- ✅ 自动端口冲突检测
- ✅ 智能端口分配
- ✅ 实时健康监控
- ✅ 用户友好的错误处理
- ✅ 完整的调试工具

用户现在可以安心启动应用，无需担心端口冲突问题。