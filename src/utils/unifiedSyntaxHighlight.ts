import * as monaco from 'monaco-editor';
import type {DatabaseLanguageType} from '@/types/database';

// Êï∞ÊçÆÂ∫ìÁâπÂÆöÁöÑËØ≠Ê≥ïÈÖçÁΩÆ
interface DatabaseSyntaxConfig {
    keywords: string[];
    functions: string[];
    dataTypes: string[];
    operators: string[];
    specialTokens: string[];
    timeUnits?: string[];
}

// ÂêÑÊï∞ÊçÆÂ∫ìÁöÑËØ≠Ê≥ïÈÖçÁΩÆ
const DATABASE_SYNTAX_CONFIGS: Record<string, DatabaseSyntaxConfig> = {
    'influxdb-1.x': {
        keywords: [
            'SELECT', 'FROM', 'WHERE', 'GROUP', 'BY', 'ORDER', 'LIMIT', 'OFFSET',
            'SHOW', 'CREATE', 'DROP', 'DELETE', 'INSERT', 'INTO', 'VALUES',
            'AND', 'OR', 'NOT', 'IN', 'LIKE', 'REGEXP', 'AS', 'ASC', 'DESC',
            'DATABASES', 'MEASUREMENTS', 'SERIES', 'TAG', 'FIELD', 'KEYS',
            'RETENTION', 'POLICIES', 'CONTINUOUS', 'QUERIES', 'FILL', 'NOW', 'TIME'
        ],
        functions: [
            'COUNT', 'SUM', 'MEAN', 'MEDIAN', 'MODE', 'SPREAD', 'STDDEV',
            'FIRST', 'LAST', 'MAX', 'MIN', 'PERCENTILE', 'TOP', 'BOTTOM',
            'DERIVATIVE', 'DIFFERENCE', 'MOVING_AVERAGE', 'CUMULATIVE_SUM'
        ],
        dataTypes: ['INTEGER', 'FLOAT', 'STRING', 'BOOLEAN', 'TIMESTAMP'],
        operators: ['=', '!=', '<>', '<', '<=', '>', '>=', '=~', '!~', '+', '-', '*', '/', '%'],
        specialTokens: ['NULL', 'NONE', 'LINEAR', 'PREVIOUS'],
        timeUnits: ['ns', 'u', '¬µ', 'ms', 's', 'm', 'h', 'd', 'w']
    },

    'influxdb-2.x': {
        keywords: [
            'FROM', 'RANGE', 'FILTER', 'GROUP', 'AGGREGATEWINDOW', 'YIELD',
            'IMPORT', 'OPTION', 'BUILTIN', 'AND', 'OR', 'NOT'
        ],
        functions: [
            'mean', 'sum', 'count', 'min', 'max', 'first', 'last',
            'stddev', 'median', 'mode', 'spread', 'skew', 'derivative',
            'difference', 'increase', 'rate', 'histogram', 'quantile'
        ],
        dataTypes: ['int', 'uint', 'float', 'string', 'bool', 'time', 'duration'],
        operators: ['==', '!=', '<', '<=', '>', '>=', '=~', '!~', '+', '-', '*', '/', '%', 'and', 'or'],
        specialTokens: ['_measurement', '_field', '_value', '_time', '_start', '_stop']
    },

    'influxdb-3.x': {
        keywords: [
            'SELECT', 'FROM', 'WHERE', 'GROUP', 'BY', 'ORDER', 'LIMIT', 'OFFSET',
            'WITH', 'AS', 'UNION', 'JOIN', 'LEFT', 'RIGHT', 'INNER', 'OUTER',
            'CASE', 'WHEN', 'THEN', 'ELSE', 'END', 'CAST', 'EXTRACT'
        ],
        functions: [
            'COUNT', 'SUM', 'AVG', 'MIN', 'MAX', 'STDDEV', 'VARIANCE',
            'FIRST_VALUE', 'LAST_VALUE', 'LAG', 'LEAD', 'ROW_NUMBER',
            'RANK', 'DENSE_RANK', 'PERCENTILE_CONT', 'PERCENTILE_DISC'
        ],
        dataTypes: ['BIGINT', 'DOUBLE', 'VARCHAR', 'BOOLEAN', 'TIMESTAMP', 'INTERVAL'],
        operators: ['=', '!=', '<>', '<', '<=', '>', '>=', 'LIKE', 'ILIKE', 'IN', 'IS'],
        specialTokens: ['NULL', 'TRUE', 'FALSE', 'CURRENT_TIMESTAMP']
    },

    'iotdb': {
        keywords: [
            'SELECT', 'FROM', 'WHERE', 'GROUP', 'BY', 'ORDER', 'LIMIT', 'OFFSET',
            'SHOW', 'CREATE', 'DROP', 'INSERT', 'INTO', 'VALUES', 'TIMESERIES',
            'STORAGE', 'GROUP', 'DEVICE', 'ALIGN', 'BY', 'DEVICE', 'TIME'
        ],
        functions: [
            'COUNT', 'SUM', 'AVG', 'MIN', 'MAX', 'FIRST_VALUE', 'LAST_VALUE',
            'MIN_TIME', 'MAX_TIME', 'STDDEV', 'STDDEV_POP', 'STDDEV_SAMP',
            'VARIANCE', 'VAR_POP', 'VAR_SAMP'
        ],
        dataTypes: ['INT32', 'INT64', 'FLOAT', 'DOUBLE', 'BOOLEAN', 'TEXT', 'TIMESTAMP'],
        operators: ['=', '!=', '<>', '<', '<=', '>', '>=', 'LIKE', 'REGEXP', 'IN'],
        specialTokens: ['NULL', 'TRUE', 'FALSE', 'NOW()']
    }
};

// Áªü‰∏ÄÁöÑËØ≠Ê≥ïÈ´ò‰∫ÆÁÆ°ÁêÜÂô® - Âü∫‰∫éÂéüÁîüSQLÊâ©Â±ï
export class UnifiedSyntaxHighlightManager {
    private registeredLanguages = new Set<string>();
    private registeredThemes = new Set<string>();

    // ÈÄöÁî®‰∏ªÈ¢òÂÆö‰πâÊñπÊ≥ï
    private defineTheme(name: string, config: monaco.editor.IStandaloneThemeData): void {
        if (this.registeredThemes.has(name)) {
            console.log(`‚úÖ ‰∏ªÈ¢ò ${name} Â∑≤Â≠òÂú®ÔºåË∑≥Ëøá`);
            return;
        }

        try {
            monaco.editor.defineTheme(name, config);
            this.registeredThemes.add(name);
            console.log(`‚úÖ ‰∏ªÈ¢ò ${name} Ê≥®ÂÜåÂÆåÊàê`);
        } catch (error) {
            console.error(`‚ùå Ê≥®ÂÜå‰∏ªÈ¢ò ${name} Â§±Ë¥•:`, error);
        }
    }

    // Ê≥®ÂÜåInfluxQLËØ≠Ë®Ä
    registerInfluxQL(): void {
        const languageId = 'unified-influxql';

        if (this.registeredLanguages.has(languageId)) {
            console.log('‚úÖ InfluxQLËØ≠Ë®ÄÂ∑≤Ê≥®ÂÜåÔºåË∑≥Ëøá');
            return;
        }

        console.log('üìù Ê≥®ÂÜåÁªü‰∏ÄInfluxQLËØ≠Ë®Ä...');

        try {
            // Ê≥®ÂÜåËØ≠Ë®Ä
            monaco.languages.register({
                id: languageId,
                extensions: ['.influxql'],
                aliases: ['InfluxQL', 'influxql'],
                mimetypes: ['text/x-influxql']
            });

            // ‰∏çËÆæÁΩÆÂ§çÊùÇÁöÑtokenizerÔºåËÆ©Monaco‰ΩøÁî®ÈªòËÆ§Â§ÑÁêÜ
            console.log('üîß Ë∑≥ËøáÂ§çÊùÇtokenizerËÆæÁΩÆÔºå‰ΩøÁî®ÈªòËÆ§Â§ÑÁêÜ');

            // ‰ΩøÁî®ÁÆÄÂçïÁöÑ‰∏ªÈ¢òÂÆö‰πâ
            this.defineTheme('unified-influxql-light', {
                base: 'vs',
                inherit: true,
                rules: [],
                colors: {}
            });

            this.defineTheme('unified-influxql-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [],
                colors: {}
            });

            this.registeredLanguages.add(languageId);
            console.log('‚úÖ Áªü‰∏ÄInfluxQLËØ≠Ë®ÄÊ≥®ÂÜåÂÆåÊàê');

        } catch (error) {
            console.error('‚ùå Ê≥®ÂÜåÁÆÄÂåñInfluxQLËØ≠Ë®ÄÂ§±Ë¥•:', error);
        }
    }

    // ‰∏∫ÁâπÂÆöÊï∞ÊçÆÂ∫ìÂàõÂª∫Â¢ûÂº∫ÁöÑËØ≠Ê≥ïÈ´ò‰∫Æ
    createEnhancedLanguage(databaseType: string): string {
        const config = DATABASE_SYNTAX_CONFIGS[databaseType];
        if (!config) {
            console.warn(`‚ö†Ô∏è Êú™ÊâæÂà∞Êï∞ÊçÆÂ∫ì ${databaseType} ÁöÑËØ≠Ê≥ïÈÖçÁΩÆÔºå‰ΩøÁî®ÈªòËÆ§SQL`);
            return 'sql';
        }

        // Monaco Editor‰∏çÂÖÅËÆ∏‰∏ªÈ¢òÂêçÁß∞‰∏≠ÂåÖÂê´ÁÇπÂè∑ÔºåÂ∞ÜÁÇπÂè∑ÊõøÊç¢‰∏∫‰∏ãÂàíÁ∫ø
        const safeDbType = databaseType.replace(/\./g, '_');
        const languageId = `enhanced-${safeDbType}`;

        if (this.registeredLanguages.has(languageId)) {
            console.log(`‚úÖ ËØ≠Ë®Ä ${languageId} Â∑≤Ê≥®ÂÜåÔºåË∑≥Ëøá`);
            return languageId;
        }

        console.log(`üìù Ê≥®ÂÜåÂ¢ûÂº∫ËØ≠Ë®Ä: ${languageId}...`);

        try {
            // Ê≥®ÂÜåËØ≠Ë®Ä
            monaco.languages.register({
                id: languageId,
                extensions: ['.sql'],
                aliases: [databaseType.toUpperCase()],
                mimetypes: ['text/x-sql']
            });

            // ËÆæÁΩÆÂ¢ûÂº∫ÁöÑtokenizerËßÑÂàô
            this.setEnhancedTokenizer(languageId, config);

            // ÂÆö‰πâÂ¢ûÂº∫ÁöÑ‰∏ªÈ¢ò
            this.defineEnhancedThemes(languageId, databaseType);

            this.registeredLanguages.add(languageId);
            console.log(`‚úÖ Â¢ûÂº∫ËØ≠Ë®Ä ${languageId} Ê≥®ÂÜåÂÆåÊàê`);

            return languageId;

        } catch (error) {
            console.error(`‚ùå Ê≥®ÂÜåÂ¢ûÂº∫ËØ≠Ë®Ä ${languageId} Â§±Ë¥•:`, error);
            return 'sql'; // ÂõûÈÄÄÂà∞ÂéüÁîüSQL
        }
    }

    // ËÆæÁΩÆÂ¢ûÂº∫ÁöÑtokenizerËßÑÂàô
    private setEnhancedTokenizer(languageId: string, config: DatabaseSyntaxConfig): void {
        // ‰ΩøÁî®MonacoÊîØÊåÅÁöÑÁÆÄÂçïÂ≠óÁ¨¶‰∏≤Ê®°ÂºèËÄå‰∏çÊòØRegExpÂØπË±°
        const keywordPattern = `\\b(?:${config.keywords.join('|')})\\b`;
        const functionPattern = `\\b(?:${config.functions.join('|')})\\b`;
        const dataTypePattern = `\\b(?:${config.dataTypes.join('|')})\\b`;
        const specialTokenPattern = `\\b(?:${config.specialTokens.join('|')})\\b`;

        // ÊûÑÂª∫tokenizerËßÑÂàôÊï∞ÁªÑ
        const tokenizerRules: any[] = [
            // Ê≥®Èáä
            [/--.*$/, 'comment'],
            [/\/\*[\s\S]*?\*\//, 'comment'],

            // Â≠óÁ¨¶‰∏≤
            [/'([^'\\]|\\.)*'/, 'string'],
            [/"([^"\\]|\\.)*"/, 'string'],
            [/`([^`\\]|\\.)*`/, 'string'], // ÂèçÂºïÂè∑Â≠óÁ¨¶‰∏≤

            // Êï∞Â≠ó
            [/\d*\.\d+([eE][+-]?\d+)?/, 'number.float'],
            [/\d+/, 'number'],
        ];

        // Ê∑ªÂä†Êó∂Èó¥Âçï‰ΩçËßÑÂàôÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
        if (config.timeUnits && config.timeUnits.length > 0) {
            const timeUnitPattern = `\\b\\d+(?:${config.timeUnits.join('|')})\\b`;
            tokenizerRules.push([new RegExp(timeUnitPattern, 'i'), 'number.time']);
        }

        // Ê∑ªÂä†ÂÖ∂‰ªñËßÑÂàô
        tokenizerRules.push(
            // Êìç‰ΩúÁ¨¶
            [/[=!<>]=?/, 'operator'],
            [/[+*/-]/, 'operator'],
            [/=~|!~/, 'operator'],
            [/\*/, 'operator'],

            // ÂàÜÈöîÁ¨¶
            [/[;,.]/, 'delimiter'],
            [/[(){}[\]]/, 'bracket'],

            // ÂÖ≥ÈîÆÂ≠ó„ÄÅÂáΩÊï∞„ÄÅÊï∞ÊçÆÁ±ªÂûã„ÄÅÁâπÊÆäÊ†áËÆ∞Ôºà‰ΩøÁî®casesÔºâ
            [/[a-zA-Z_]\w*/, {
                cases: {
                    [keywordPattern]: {token: 'keyword'},
                    [functionPattern]: {token: 'function'},
                    [dataTypePattern]: {token: 'type'},
                    [specialTokenPattern]: {token: 'constant'},
                    '@default': 'identifier'
                }
            }],

            // Á©∫ÁôΩÂ≠óÁ¨¶
            [/\s+/, ''],

            // ÂÖ∂‰ªñ
            [/./, 'text']
        );

        monaco.languages.setMonarchTokensProvider(languageId, {
            // ÂÆö‰πâÂÖ≥ÈîÆÂ≠óÂàóË°®
            keywords: config.keywords,
            functions: config.functions,
            dataTypes: config.dataTypes,
            specialTokens: config.specialTokens,

            // ‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜô
            ignoreCase: true,

            tokenizer: {
                root: tokenizerRules
            }
        });
    }

    // ÂÆö‰πâÂ¢ûÂº∫ÁöÑ‰∏ªÈ¢ò
    private defineEnhancedThemes(languageId: string, databaseType: string): void {
        // ‰∫ÆËâ≤‰∏ªÈ¢ò
        this.defineTheme(`${languageId}-light`, {
            base: 'vs',
            inherit: true,
            rules: [
                {token: 'comment', foreground: '008000', fontStyle: 'italic'},
                {token: 'keyword', foreground: '0000FF', fontStyle: 'bold'},
                {token: 'function', foreground: 'FF6600', fontStyle: 'bold'},
                {token: 'type', foreground: '2B91AF', fontStyle: 'bold'},
                {token: 'constant', foreground: '800080', fontStyle: 'bold'},
                {token: 'number', foreground: '098658'},
                {token: 'number.float', foreground: '098658'},
                {token: 'number.time', foreground: 'FF6600', fontStyle: 'bold'},
                {token: 'string', foreground: 'A31515'},
                {token: 'operator', foreground: '666666', fontStyle: 'bold'},
                {token: 'identifier', foreground: '000000'},
                {token: 'delimiter', foreground: '666666'},
                {token: 'bracket', foreground: '000000', fontStyle: 'bold'}
            ],
            colors: {}
        });

        // ÊöóËâ≤‰∏ªÈ¢ò
        this.defineTheme(`${languageId}-dark`, {
            base: 'vs-dark',
            inherit: true,
            rules: [
                {token: 'comment', foreground: '6A9955', fontStyle: 'italic'},
                {token: 'keyword', foreground: '569CD6', fontStyle: 'bold'},
                {token: 'function', foreground: 'DCDCAA', fontStyle: 'bold'},
                {token: 'type', foreground: '4EC9B0', fontStyle: 'bold'},
                {token: 'constant', foreground: 'D19A66', fontStyle: 'bold'},
                {token: 'number', foreground: 'B5CEA8'},
                {token: 'number.float', foreground: 'B5CEA8'},
                {token: 'number.time', foreground: 'FF9500', fontStyle: 'bold'},
                {token: 'string', foreground: 'CE9178'},
                {token: 'operator', foreground: 'CCCCCC', fontStyle: 'bold'},
                {token: 'identifier', foreground: 'D4D4D4'},
                {token: 'delimiter', foreground: 'CCCCCC'},
                {token: 'bracket', foreground: 'FFD700', fontStyle: 'bold'}
            ],
            colors: {}
        });
    }

    // Ëé∑ÂèñÊï∞ÊçÆÂ∫ìÁâπÂÆöÁöÑËØ≠Ë®ÄID
    getLanguageForDatabase(databaseType: string): string {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÁâπÂÆöÁöÑÊï∞ÊçÆÂ∫ìÈÖçÁΩÆ
        if (DATABASE_SYNTAX_CONFIGS[databaseType]) {
            return this.createEnhancedLanguage(databaseType);
        }

        // ÂõûÈÄÄÂà∞ÂéüÁîüSQL
        return 'sql';
    }

    // Ëé∑ÂèñÊï∞ÊçÆÂ∫ìÁâπÂÆöÁöÑ‰∏ªÈ¢òÂêçÁß∞
    getThemeForDatabase(databaseType: string, isDark: boolean): string {
        const languageId = this.getLanguageForDatabase(databaseType);

        if (languageId.startsWith('enhanced-')) {
            return `${languageId}-${isDark ? 'dark' : 'light'}`;
        }

        // ÂéüÁîü‰∏ªÈ¢ò
        return isDark ? 'vs-dark' : 'vs';
    }

    // Ëé∑ÂèñÊîØÊåÅÁöÑÊï∞ÊçÆÂ∫ìÁ±ªÂûãÂàóË°®
    getSupportedDatabases(): string[] {
        return Object.keys(DATABASE_SYNTAX_CONFIGS);
    }

    // Ê£ÄÊü•Êï∞ÊçÆÂ∫ìÊòØÂê¶ÊîØÊåÅÂ¢ûÂº∫ËØ≠Ê≥ïÈ´ò‰∫Æ
    isDatabaseSupported(databaseType: string): boolean {
        return databaseType in DATABASE_SYNTAX_CONFIGS;
    }

    // Ê≥®ÂÜåSQLËØ≠Ë®Ä
    registerSQL(): void {
        const languageId = 'unified-sql';

        if (this.registeredLanguages.has(languageId)) {
            console.log('‚úÖ SQLËØ≠Ë®ÄÂ∑≤Ê≥®ÂÜåÔºåË∑≥Ëøá');
            return;
        }

        console.log('üìù Ê≥®ÂÜåÁªü‰∏ÄSQLËØ≠Ë®Ä...');

        try {
            // Ê≥®ÂÜåËØ≠Ë®Ä
            monaco.languages.register({
                id: languageId,
                extensions: ['.sql'],
                aliases: ['SQL', 'sql'],
                mimetypes: ['text/x-sql']
            });

            // ËÆæÁΩÆËØ≠Ê≥ïÈ´ò‰∫ÆËßÑÂàô
            monaco.languages.setMonarchTokensProvider(languageId, {
                keywords: [
                    'SELECT', 'FROM', 'WHERE', 'JOIN', 'INNER', 'LEFT', 'RIGHT', 'FULL', 'OUTER',
                    'ON', 'GROUP', 'BY', 'HAVING', 'ORDER', 'ASC', 'DESC', 'LIMIT', 'OFFSET',
                    'INSERT', 'INTO', 'VALUES', 'UPDATE', 'SET', 'DELETE', 'CREATE', 'TABLE',
                    'ALTER', 'DROP', 'INDEX', 'VIEW', 'DATABASE', 'SCHEMA',
                    'AND', 'OR', 'NOT', 'IN', 'EXISTS', 'BETWEEN', 'LIKE', 'IS', 'NULL',
                    'TRUE', 'FALSE', 'CASE', 'WHEN', 'THEN', 'ELSE', 'END'
                ],

                builtins: [
                    'COUNT', 'SUM', 'AVG', 'MIN', 'MAX', 'FIRST', 'LAST',
                    'UPPER', 'LOWER', 'LENGTH', 'SUBSTRING', 'TRIM', 'CONCAT',
                    'NOW', 'GETDATE', 'DATEADD', 'DATEDIFF', 'YEAR', 'MONTH', 'DAY',
                    'ABS', 'ROUND', 'FLOOR', 'CEILING', 'CAST', 'CONVERT'
                ],

                tokenizer: {
                    root: [
                        // Ê≥®Èáä
                        [/--.*$/, 'comment'],
                        [/\/\*/, 'comment', '@comment'],

                        // Â≠óÁ¨¶‰∏≤
                        [/'([^'\\]|\\.)*$/, 'string.invalid'],
                        [/'/, 'string', '@string'],
                        [/"([^"\\]|\\.)*$/, 'string.invalid'],
                        [/"/, 'string', '@dstring'],

                        // Êï∞Â≠ó
                        [/\d*\.\d+([eE][+-]?\d+)?/, 'number.float'],
                        [/\d+/, 'number'],

                        // ÂÖ≥ÈîÆÂ≠óÂíåÂáΩÊï∞
                        [/[a-zA-Z_]\w*/, {
                            cases: {
                                '@keywords': 'keyword',
                                '@builtins': 'keyword.function',
                                '@default': 'identifier'
                            }
                        }],

                        // Êìç‰ΩúÁ¨¶
                        [/[=!<>]=?/, 'operator'],
                        [/[+*/-]/, 'operator'],

                        // ÂàÜÈöîÁ¨¶
                        [/[;,.]/, 'delimiter'],
                        [/[(){}[\]]/, 'bracket'],

                        // Á©∫ÁôΩÂ≠óÁ¨¶
                        [/\s+/, 'white'],
                    ],

                    comment: [
                        [/[^/*]+/, 'comment'],
                        [/\*\//, 'comment', '@pop'],
                        [/[/*]/, 'comment']
                    ],

                    string: [
                        [/[^\\']+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/'/, 'string', '@pop']
                    ],

                    dstring: [
                        [/[^\\"]+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/"/, 'string', '@pop']
                    ]
                }
            });

            // ÂÆö‰πâSQL‰∏ªÈ¢ò
            this.defineTheme('unified-sql-light', {
                base: 'vs',
                inherit: true,
                rules: [
                    {token: 'comment', foreground: '008000', fontStyle: 'italic'},
                    {token: 'keyword', foreground: '0000FF', fontStyle: 'bold'},
                    {token: 'keyword.function', foreground: 'DC143C', fontStyle: 'bold'},
                    {token: 'string', foreground: 'A31515'},
                    {token: 'string.escape', foreground: 'FF0000'},
                    {token: 'number', foreground: '098658'},
                    {token: 'number.float', foreground: '098658'},
                    {token: 'operator', foreground: '666666', fontStyle: 'bold'},
                    {token: 'identifier', foreground: '000000'},
                    {token: 'delimiter', foreground: '666666'},
                    {token: 'bracket', foreground: '000000', fontStyle: 'bold'}
                ],
                colors: {}
            });

            // ÂÆö‰πâSQLÊöóËâ≤‰∏ªÈ¢ò
            this.defineTheme('unified-sql-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    {token: 'comment', foreground: '6A9955', fontStyle: 'italic'},
                    {token: 'keyword', foreground: '569CD6', fontStyle: 'bold'},
                    {token: 'keyword.function', foreground: 'FF6B6B', fontStyle: 'bold'},
                    {token: 'string', foreground: 'CE9178'},
                    {token: 'string.escape', foreground: 'D7BA7D'},
                    {token: 'number', foreground: 'B5CEA8'},
                    {token: 'number.float', foreground: 'B5CEA8'},
                    {token: 'operator', foreground: 'CCCCCC', fontStyle: 'bold'},
                    {token: 'identifier', foreground: 'D4D4D4'},
                    {token: 'delimiter', foreground: 'CCCCCC'},
                    {token: 'bracket', foreground: 'FFD700', fontStyle: 'bold'}
                ],
                colors: {}
            });

            this.registeredLanguages.add(languageId);
            console.log('‚úÖ Áªü‰∏ÄSQLËØ≠Ë®ÄÊ≥®ÂÜåÂÆåÊàê');

        } catch (error) {
            console.error('‚ùå Ê≥®ÂÜåÁÆÄÂåñSQLËØ≠Ë®ÄÂ§±Ë¥•:', error);
        }
    }

    // Ê≥®ÂÜåFluxËØ≠Ë®Ä
    registerFlux(): void {
        const languageId = 'unified-flux';

        if (this.registeredLanguages.has(languageId)) {
            console.log('‚úÖ FluxËØ≠Ë®ÄÂ∑≤Ê≥®ÂÜåÔºåË∑≥Ëøá');
            return;
        }

        console.log('üìù Ê≥®ÂÜåÁªü‰∏ÄFluxËØ≠Ë®Ä...');

        try {
            // Ê≥®ÂÜåËØ≠Ë®Ä
            monaco.languages.register({
                id: languageId,
                extensions: ['.flux'],
                aliases: ['Flux', 'flux'],
                mimetypes: ['text/x-flux']
            });

            // ËÆæÁΩÆËØ≠Ê≥ïÈ´ò‰∫ÆËßÑÂàô
            monaco.languages.setMonarchTokensProvider(languageId, {
                keywords: [
                    'import', 'package', 'option', 'builtin', 'testcase',
                    'if', 'then', 'else', 'return', 'and', 'or', 'not',
                    'true', 'false', 'null', 'exists'
                ],

                builtins: [
                    'from', 'range', 'filter', 'group', 'aggregateWindow', 'mean', 'sum', 'count',
                    'max', 'min', 'first', 'last', 'map', 'keep', 'drop', 'pivot', 'join',
                    'union', 'yield', 'to', 'sort', 'limit', 'unique', 'distinct',
                    'window', 'timeShift', 'fill', 'interpolate', 'derivative', 'difference'
                ],

                tokenizer: {
                    root: [
                        // Ê≥®Èáä
                        [/\/\/.*$/, 'comment'],
                        [/\/\*/, 'comment', '@comment'],

                        // Â≠óÁ¨¶‰∏≤
                        [/"([^"\\]|\\.)*$/, 'string.invalid'],
                        [/"/, 'string', '@dstring'],

                        // Êï∞Â≠ó
                        [/\d*\.\d+([eE][+-]?\d+)?/, 'number.float'],
                        [/\d+/, 'number'],

                        // ÁÆ°ÈÅìÊìç‰ΩúÁ¨¶
                        [/\|>/, 'operator.pipe'],

                        // ÂÖ≥ÈîÆÂ≠óÂíåÂáΩÊï∞
                        [/[a-zA-Z_]\w*/, {
                            cases: {
                                '@keywords': 'keyword',
                                '@builtins': 'keyword.function',
                                '@default': 'identifier'
                            }
                        }],

                        // Êìç‰ΩúÁ¨¶
                        [/[=!<>]=?/, 'operator'],
                        [/[+*/-]/, 'operator'],

                        // ÂàÜÈöîÁ¨¶
                        [/[;,.]/, 'delimiter'],
                        [/[(){}[\]]/, 'bracket'],

                        // Á©∫ÁôΩÂ≠óÁ¨¶
                        [/\s+/, 'white'],
                    ],

                    comment: [
                        [/[^/*]+/, 'comment'],
                        [/\*\//, 'comment', '@pop'],
                        [/[/*]/, 'comment']
                    ],

                    dstring: [
                        [/[^\\"]+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/"/, 'string', '@pop']
                    ]
                }
            });

            // ÂÆö‰πâFlux‰∏ªÈ¢ò
            this.defineTheme('unified-flux-light', {
                base: 'vs',
                inherit: true,
                rules: [
                    {token: 'comment', foreground: '008000', fontStyle: 'italic'},
                    {token: 'keyword', foreground: '0000FF', fontStyle: 'bold'},
                    {token: 'keyword.function', foreground: 'DC143C', fontStyle: 'bold'},
                    {token: 'string', foreground: 'A31515'},
                    {token: 'string.escape', foreground: 'FF0000'},
                    {token: 'number', foreground: '098658'},
                    {token: 'number.float', foreground: '098658'},
                    {token: 'operator', foreground: '666666', fontStyle: 'bold'},
                    {token: 'operator.pipe', foreground: 'FF6600', fontStyle: 'bold'},
                    {token: 'identifier', foreground: '000000'},
                    {token: 'delimiter', foreground: '666666'},
                    {token: 'bracket', foreground: '000000', fontStyle: 'bold'}
                ],
                colors: {}
            });

            this.defineTheme('unified-flux-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    {token: 'comment', foreground: '6A9955', fontStyle: 'italic'},
                    {token: 'keyword', foreground: '569CD6', fontStyle: 'bold'},
                    {token: 'keyword.function', foreground: 'FF6B6B', fontStyle: 'bold'},
                    {token: 'string', foreground: 'CE9178'},
                    {token: 'string.escape', foreground: 'D7BA7D'},
                    {token: 'number', foreground: 'B5CEA8'},
                    {token: 'number.float', foreground: 'B5CEA8'},
                    {token: 'operator', foreground: 'CCCCCC', fontStyle: 'bold'},
                    {token: 'operator.pipe', foreground: 'FF9500', fontStyle: 'bold'},
                    {token: 'identifier', foreground: 'D4D4D4'},
                    {token: 'delimiter', foreground: 'CCCCCC'},
                    {token: 'bracket', foreground: 'FFD700', fontStyle: 'bold'}
                ],
                colors: {}
            });

            this.registeredLanguages.add(languageId);
            console.log('‚úÖ Áªü‰∏ÄFluxËØ≠Ë®ÄÊ≥®ÂÜåÂÆåÊàê');

        } catch (error) {
            console.error('‚ùå Ê≥®ÂÜåÁªü‰∏ÄFluxËØ≠Ë®ÄÂ§±Ë¥•:', error);
        }
    }

    // Ê≥®ÂÜåÊâÄÊúâËØ≠Ë®Ä
    registerAll(): void {
        console.log('üöÄ ÂºÄÂßãÊ≥®ÂÜåÊâÄÊúâÁªü‰∏ÄËØ≠Ê≥ïÈ´ò‰∫Æ...');
        this.registerSQL();
        this.registerInfluxQL();
        this.registerFlux();
        console.log('üéâ ÊâÄÊúâÁªü‰∏ÄËØ≠Ê≥ïÈ´ò‰∫ÆÊ≥®ÂÜåÂÆåÊàê');
    }

    // Ëé∑ÂèñËØ≠Ë®ÄID
    getLanguageId(databaseType: DatabaseLanguageType): string {
        switch (databaseType) {
            case 'influxql':
                return 'unified-influxql';
            case 'flux':
                return 'unified-flux';
            case 'sql':
            case 'mysql':
            case 'postgresql':
            case 'mongodb':
            default:
                return 'unified-sql';
        }
    }

    // Ëé∑Âèñ‰∏ªÈ¢òÂêçÁß∞
    getThemeName(languageType: DatabaseLanguageType, isDark: boolean): string {
        const suffix = isDark ? '-dark' : '-light';
        switch (languageType) {
            case 'influxql':
                return `unified-influxql${suffix}`;
            case 'flux':
                return `unified-flux${suffix}`;
            case 'sql':
            case 'mysql':
            case 'postgresql':
            case 'mongodb':
            default:
                return `unified-sql${suffix}`;
        }
    }

    // È™åËØÅËØ≠Ê≥ïÈ´ò‰∫Æ
    validateSyntaxHighlight(editor: monaco.editor.IStandaloneCodeEditor): void {
        console.log('üîç È™åËØÅÁªü‰∏ÄËØ≠Ê≥ïÈ´ò‰∫ÆÁä∂ÊÄÅ...');

        try {
            const model = editor.getModel();
            if (!model) {
                console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñÁºñËæëÂô®Ê®°Âûã');
                return;
            }

            const languageId = model.getLanguageId();
            console.log('üìã ÂΩìÂâçËØ≠Ë®ÄID:', languageId);

            // Ê£ÄÊü•DOM‰∏≠ÁöÑËØ≠Ê≥ïÈ´ò‰∫ÆÂÖÉÁ¥†
            const editorDom = editor.getDomNode();
            if (editorDom) {
                const tokenElements = editorDom.querySelectorAll('.view-line .mtk1, .view-line .mtk2, .view-line .mtk3, .view-line .mtk4, .view-line .mtk5, .view-line .mtk6, .view-line .mtk7, .view-line .mtk8, .view-line .mtk9');
                console.log('üé® ÊâæÂà∞ÁöÑËØ≠Ê≥ïÈ´ò‰∫ÆÂÖÉÁ¥†Êï∞Èáè:', tokenElements.length);

                const tokenStats: Record<string, number> = {};
                Array.from(tokenElements).forEach(el => {
                    const className = el.className;
                    tokenStats[className] = (tokenStats[className] || 0) + 1;
                });
                console.log('üé® ËØ≠Ê≥ïÈ´ò‰∫ÆÂÖÉÁ¥†ÁªüËÆ°:', tokenStats);

                if (Object.keys(tokenStats).length > 1) {
                    console.log('‚úÖ Áªü‰∏ÄËØ≠Ê≥ïÈ´ò‰∫ÆÈ™åËØÅÊàêÂäü');
                } else {
                    console.warn('‚ö†Ô∏è Áªü‰∏ÄËØ≠Ê≥ïÈ´ò‰∫ÆÂèØËÉΩÊú™Ê≠£Á°ÆÂ∑•‰Ωú');
                }
            }
        } catch (error) {
            console.error('‚ùå È™åËØÅËØ≠Ê≥ïÈ´ò‰∫ÆÂ§±Ë¥•:', error);
        }
    }
}

// ÂàõÂª∫ÂÖ®Â±ÄÂÆû‰æã
export const unifiedSyntaxManager = new UnifiedSyntaxHighlightManager();