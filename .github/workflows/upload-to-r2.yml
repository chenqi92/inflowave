name: Upload to Cloudflare R2

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š1.0.0ï¼Œä¸éœ€è¦ v å‰ç¼€ï¼‰'
        required: true
        type: string
      upload_macos_arm:
        description: 'ä¸Šä¼  macOS ARM64 åŒ…'
        required: false
        type: boolean
        default: true
      upload_windows_x64:
        description: 'ä¸Šä¼  Windows x64 MSI åŒ…'
        required: false
        type: boolean
        default: true
      update_release_notes:
        description: 'æ›´æ–° Release è¯´æ˜ï¼ˆæ·»åŠ  R2 ä¸‹è½½é“¾æ¥ï¼‰'
        required: false
        type: boolean
        default: true
  
  # æ”¯æŒè¢«å…¶ä»– workflow è°ƒç”¨
  workflow_call:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š1.0.0ï¼Œä¸éœ€è¦ v å‰ç¼€ï¼‰'
        required: true
        type: string
      upload_macos_arm:
        description: 'ä¸Šä¼  macOS ARM64 åŒ…'
        required: false
        type: boolean
        default: true
      upload_windows_x64:
        description: 'ä¸Šä¼  Windows x64 MSI åŒ…'
        required: false
        type: boolean
        default: true
      update_release_notes:
        description: 'æ›´æ–° Release è¯´æ˜ï¼ˆæ·»åŠ  R2 ä¸‹è½½é“¾æ¥ï¼‰'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify AWS CLI
        run: |
          echo "ğŸ“¦ Verifying AWS CLI installation..."
          aws --version
          echo "âœ… AWS CLI is ready"

      - name: Configure AWS CLI for Cloudflare R2
        run: |
          echo "ğŸ”§ Configuring AWS CLI for Cloudflare R2..."
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set default.region auto
          echo "âœ… AWS CLI configured"

      - name: Download release assets
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading release assets from GitHub Release..."
          VERSION="${{ inputs.version }}"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p ./r2-upload
          cd ./r2-upload
          
          # ä¸‹è½½ macOS ARM64 DMG
          if [[ "${{ inputs.upload_macos_arm }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading macOS ARM64 DMG..."
            gh release download "v${VERSION}" \
              --pattern "*aarch64*.dmg" \
              --repo ${{ github.repository }} || echo "âš ï¸ macOS ARM64 DMG not found"
          fi
          
          # ä¸‹è½½ Windows x64 MSI
          if [[ "${{ inputs.upload_windows_x64 }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Windows x64 MSI..."
            gh release download "v${VERSION}" \
              --pattern "*x64*.msi" \
              --repo ${{ github.repository }} || echo "âš ï¸ Windows x64 MSI not found"
          fi
          
          # åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
          echo "ğŸ“‹ Downloaded files:"
          ls -lh
          
          cd ..

      - name: Upload to Cloudflare R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "â˜ï¸ Uploading files to Cloudflare R2..."
          VERSION="${{ inputs.version }}"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ 
          if [ -z "$(ls -A ./r2-upload)" ]; then
            echo "âš ï¸ No files to upload"
            exit 0
          fi
          
          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶åˆ° R2
          UPLOAD_COUNT=0
          for file in ./r2-upload/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              echo "ğŸ“¤ Uploading: $filename ($filesize)"
              
              # ä¸Šä¼ åˆ° R2ï¼Œè·¯å¾„æ ¼å¼: releases/v{version}/{filename}
              if aws s3 cp "$file" \
                "s3://${R2_BUCKET}/releases/v${VERSION}/${filename}" \
                --endpoint-url "${R2_ENDPOINT}" \
                --acl public-read; then
                echo "âœ… Successfully uploaded: $filename"
                UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
              else
                echo "âŒ Failed to upload: $filename"
              fi
            fi
          done
          
          echo "ğŸ‰ Upload completed! Total files uploaded: $UPLOAD_COUNT"

      - name: Generate download URLs
        if: inputs.update_release_notes == true
        env:
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”— Generating download URLs..."
          VERSION="${{ inputs.version }}"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          if [ -z "$(ls -A ./r2-upload)" ]; then
            echo "âš ï¸ No files to generate URLs for"
            exit 0
          fi

          echo "## Cloudflare R2 ä¸‹è½½é“¾æ¥ï¼ˆå›½å†…è®¿é—®ä¼˜åŒ–ï¼‰" > r2-urls.md
          echo "" >> r2-urls.md
          echo "ä»¥ä¸‹æ–‡ä»¶å·²ä¸Šä¼ åˆ° Cloudflare R2ï¼Œæä¾›æ›´å¿«çš„å›½å†…è®¿é—®é€Ÿåº¦ï¼š" >> r2-urls.md
          echo "" >> r2-urls.md

          for file in ./r2-upload/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)

              # å¦‚æœé…ç½®äº†å…¬å…± URLï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤æ ¼å¼
              if [ -n "${R2_PUBLIC_URL}" ]; then
                # ç¡®ä¿ URL åŒ…å«åè®®å‰ç¼€
                if [[ "${R2_PUBLIC_URL}" =~ ^https?:// ]]; then
                  base_url="${R2_PUBLIC_URL}"
                else
                  base_url="https://${R2_PUBLIC_URL}"
                fi
                url="${base_url}/releases/v${VERSION}/${filename}"
              else
                url="https://${R2_BUCKET}.r2.dev/releases/v${VERSION}/${filename}"
              fi

              echo "- **${filename}** (${filesize}): [ä¸‹è½½é“¾æ¥](${url})" >> r2-urls.md
            fi
          done

          echo "" >> r2-urls.md
          echo "---" >> r2-urls.md
          echo "" >> r2-urls.md
          cat r2-urls.md

          # è·å–å½“å‰ Release è¯´æ˜
          CURRENT_NOTES=$(gh release view "v${VERSION}" --json body -q .body --repo ${{ github.repository }})

          # æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å« R2 é“¾æ¥
          if echo "$CURRENT_NOTES" | grep -q "Cloudflare R2"; then
            echo "âš ï¸ Release notes already contain R2 links, skipping update"
          else
            # å°† R2 é“¾æ¥è¿½åŠ åˆ°ç°æœ‰è¯´æ˜
            {
              echo "$CURRENT_NOTES"
              echo ""
              cat r2-urls.md
            } > combined-notes.md

            # æ›´æ–° Release è¯´æ˜
            gh release edit "v${VERSION}" \
              --notes-file combined-notes.md \
              --repo ${{ github.repository }}

            echo "âœ… Release notes updated with R2 download links"
          fi

      - name: Update README with R2 mirror links
        if: inputs.update_release_notes == true
        env:
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "ğŸ“ Updating README.md with R2 mirror links..."
          VERSION="${{ inputs.version }}"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          if [ -z "$(ls -A ./r2-upload)" ]; then
            echo "âš ï¸ No files to update in README"
            exit 0
          fi

          # æ£€æŸ¥ README.md æ˜¯å¦å­˜åœ¨
          if [ ! -f "README.md" ]; then
            echo "âš ï¸ README.md not found, skipping update"
            exit 0
          fi

          # ç¡®ä¿ URL åŒ…å«åè®®å‰ç¼€
          if [ -n "${R2_PUBLIC_URL}" ]; then
            if [[ "${R2_PUBLIC_URL}" =~ ^https?:// ]]; then
              base_url="${R2_PUBLIC_URL}"
            else
              base_url="https://${R2_PUBLIC_URL}"
            fi
          else
            base_url="https://${R2_BUCKET}.r2.dev"
          fi

          # ç”Ÿæˆ R2 é•œåƒé“¾æ¥å¹¶æ›´æ–° README
          for file in ./r2-upload/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              r2_url="${base_url}/releases/v${VERSION}/${filename}"
              github_url="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/${filename}"

              echo "ğŸ”„ Updating link for: $filename"
              echo "   GitHub: $github_url"
              echo "   R2: $r2_url"

              # åœ¨ README ä¸­æŸ¥æ‰¾ GitHub ä¸‹è½½é“¾æ¥ï¼Œå¹¶åœ¨å…¶åæ·»åŠ å›½å†…é•œåƒé“¾æ¥
              # ä½¿ç”¨ sed åœ¨æ¯ä¸ª GitHub ä¸‹è½½é“¾æ¥åæ·»åŠ å›½å†…é•œåƒæç¤º
              if grep -q "$github_url" README.md; then
                # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å›½å†…é•œåƒé“¾æ¥
                if ! grep -q "å›½å†…é•œåƒ.*$filename" README.md; then
                  # åœ¨ GitHub é“¾æ¥æ‰€åœ¨è¡Œåæ·»åŠ å›½å†…é•œåƒé“¾æ¥
                  sed -i "s|\($github_url\)|\1 \| [ğŸ‡¨ğŸ‡³ å›½å†…é•œåƒ]($r2_url)|g" README.md
                  echo "   âœ… Added R2 mirror link"
                else
                  # æ›´æ–°ç°æœ‰çš„å›½å†…é•œåƒé“¾æ¥
                  sed -i "s|\[ğŸ‡¨ğŸ‡³ å›½å†…é•œåƒ\]([^)]*$filename)|\[ğŸ‡¨ğŸ‡³ å›½å†…é•œåƒ\]($r2_url)|g" README.md
                  echo "   âœ… Updated existing R2 mirror link"
                fi
              else
                echo "   âš ï¸ GitHub link not found in README"
              fi
            fi
          done

          echo "âœ… README.md updated with R2 mirror links"

      - name: Commit and push README changes
        if: inputs.update_release_notes == true
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet README.md; then
            echo "â„¹ï¸ No changes to README.md"
          else
            git add README.md
            git commit -m "docs: update download links to v${{ inputs.version }}"
            git push
            echo "âœ… README.md changes committed and pushed"
          fi

