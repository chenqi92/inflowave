name: Upload to Cloudflare R2

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š1.0.0ï¼Œä¸éœ€è¦ v å‰ç¼€ï¼‰'
        required: true
        type: string
      upload_macos_arm:
        description: 'ä¸Šä¼  macOS ARM64 åŒ…'
        required: false
        type: boolean
        default: true
      upload_windows_x64:
        description: 'ä¸Šä¼  Windows x64 MSI åŒ…'
        required: false
        type: boolean
        default: true
      update_release_notes:
        description: 'æ›´æ–° Release è¯´æ˜Žï¼ˆæ·»åŠ  R2 ä¸‹è½½é“¾æŽ¥ï¼‰'
        required: false
        type: boolean
        default: true
  
  # æ”¯æŒè¢«å…¶ä»– workflow è°ƒç”¨
  workflow_call:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š1.0.0ï¼Œä¸éœ€è¦ v å‰ç¼€ï¼‰'
        required: true
        type: string
      upload_macos_arm:
        description: 'ä¸Šä¼  macOS ARM64 åŒ…'
        required: false
        type: boolean
        default: true
      upload_windows_x64:
        description: 'ä¸Šä¼  Windows x64 MSI åŒ…'
        required: false
        type: boolean
        default: true
      update_release_notes:
        description: 'æ›´æ–° Release è¯´æ˜Žï¼ˆæ·»åŠ  R2 ä¸‹è½½é“¾æŽ¥ï¼‰'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install AWS CLI
        run: |
          echo "ðŸ“¦ Installing AWS CLI..."
          # ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬å®‰è£… AWS CLI v2
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
          aws --version
          echo "âœ… AWS CLI installed successfully"

      - name: Configure AWS CLI for Cloudflare R2
        run: |
          echo "ðŸ”§ Configuring AWS CLI for Cloudflare R2..."
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set default.region auto
          echo "âœ… AWS CLI configured"

      - name: Download release assets
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¥ Downloading release assets from GitHub Release..."
          VERSION="${{ inputs.version }}"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p ./r2-upload
          cd ./r2-upload
          
          # ä¸‹è½½ macOS ARM64 DMG
          if [[ "${{ inputs.upload_macos_arm }}" == "true" ]]; then
            echo "ðŸ“¦ Downloading macOS ARM64 DMG..."
            gh release download "v${VERSION}" \
              --pattern "*aarch64*.dmg" \
              --repo ${{ github.repository }} || echo "âš ï¸ macOS ARM64 DMG not found"
          fi
          
          # ä¸‹è½½ Windows x64 MSI
          if [[ "${{ inputs.upload_windows_x64 }}" == "true" ]]; then
            echo "ðŸ“¦ Downloading Windows x64 MSI..."
            gh release download "v${VERSION}" \
              --pattern "*x64*.msi" \
              --repo ${{ github.repository }} || echo "âš ï¸ Windows x64 MSI not found"
          fi
          
          # åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
          echo "ðŸ“‹ Downloaded files:"
          ls -lh
          
          cd ..

      - name: Upload to Cloudflare R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "â˜ï¸ Uploading files to Cloudflare R2..."
          VERSION="${{ inputs.version }}"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ 
          if [ -z "$(ls -A ./r2-upload)" ]; then
            echo "âš ï¸ No files to upload"
            exit 0
          fi
          
          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶åˆ° R2
          UPLOAD_COUNT=0
          for file in ./r2-upload/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              echo "ðŸ“¤ Uploading: $filename ($filesize)"
              
              # ä¸Šä¼ åˆ° R2ï¼Œè·¯å¾„æ ¼å¼: releases/v{version}/{filename}
              if aws s3 cp "$file" \
                "s3://${R2_BUCKET}/releases/v${VERSION}/${filename}" \
                --endpoint-url "${R2_ENDPOINT}" \
                --acl public-read; then
                echo "âœ… Successfully uploaded: $filename"
                UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
              else
                echo "âŒ Failed to upload: $filename"
              fi
            fi
          done
          
          echo "ðŸŽ‰ Upload completed! Total files uploaded: $UPLOAD_COUNT"

      - name: Generate download URLs
        if: inputs.update_release_notes == true
        env:
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”— Generating download URLs..."
          VERSION="${{ inputs.version }}"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          if [ -z "$(ls -A ./r2-upload)" ]; then
            echo "âš ï¸ No files to generate URLs for"
            exit 0
          fi

          echo "## Cloudflare R2 ä¸‹è½½é“¾æŽ¥ï¼ˆå›½å†…è®¿é—®ä¼˜åŒ–ï¼‰" > r2-urls.md
          echo "" >> r2-urls.md
          echo "ä»¥ä¸‹æ–‡ä»¶å·²ä¸Šä¼ åˆ° Cloudflare R2ï¼Œæä¾›æ›´å¿«çš„å›½å†…è®¿é—®é€Ÿåº¦ï¼š" >> r2-urls.md
          echo "" >> r2-urls.md

          for file in ./r2-upload/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)

              # å¦‚æžœé…ç½®äº†å…¬å…± URLï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤æ ¼å¼
              if [ -n "${R2_PUBLIC_URL}" ]; then
                url="${R2_PUBLIC_URL}/releases/v${VERSION}/${filename}"
              else
                url="https://${R2_BUCKET}.r2.dev/releases/v${VERSION}/${filename}"
              fi

              echo "- **${filename}** (${filesize}): [ä¸‹è½½é“¾æŽ¥]($url)" >> r2-urls.md
            fi
          done

          echo "" >> r2-urls.md
          echo "---" >> r2-urls.md
          echo "" >> r2-urls.md
          cat r2-urls.md

          # èŽ·å–å½“å‰ Release è¯´æ˜Ž
          CURRENT_NOTES=$(gh release view "v${VERSION}" --json body -q .body --repo ${{ github.repository }})

          # æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å« R2 é“¾æŽ¥
          if echo "$CURRENT_NOTES" | grep -q "Cloudflare R2"; then
            echo "âš ï¸ Release notes already contain R2 links, skipping update"
          else
            # å°† R2 é“¾æŽ¥è¿½åŠ åˆ°çŽ°æœ‰è¯´æ˜Ž
            {
              echo "$CURRENT_NOTES"
              echo ""
              cat r2-urls.md
            } > combined-notes.md

            # æ›´æ–° Release è¯´æ˜Ž
            gh release edit "v${VERSION}" \
              --notes-file combined-notes.md \
              --repo ${{ github.repository }}

            echo "âœ… Release notes updated with R2 download links"
          fi

