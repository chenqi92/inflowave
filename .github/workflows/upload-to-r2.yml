name: Upload to Cloudflare R2

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š1.0.0ï¼Œä¸éœ€è¦ v å‰ç¼€ï¼‰'
        required: true
        type: string
      # macOS åŒ…
      upload_macos_arm64:
        description: 'ä¸Šä¼  macOS ARM64 DMG'
        required: false
        type: boolean
        default: true
      upload_macos_x64:
        description: 'ä¸Šä¼  macOS x64 DMG'
        required: false
        type: boolean
        default: false
      # Windows åŒ…
      upload_windows_x64_msi:
        description: 'ä¸Šä¼  Windows x64 MSI'
        required: false
        type: boolean
        default: true
      upload_windows_x64_nsis:
        description: 'ä¸Šä¼  Windows x64 NSIS'
        required: false
        type: boolean
        default: false
      upload_windows_x86_msi:
        description: 'ä¸Šä¼  Windows x86 MSI'
        required: false
        type: boolean
        default: false
      upload_windows_x86_nsis:
        description: 'ä¸Šä¼  Windows x86 NSIS'
        required: false
        type: boolean
        default: false
      # Linux x64 åŒ…
      upload_linux_x64_deb:
        description: 'ä¸Šä¼  Linux x64 DEB'
        required: false
        type: boolean
        default: false
      upload_linux_x64_rpm:
        description: 'ä¸Šä¼  Linux x64 RPM'
        required: false
        type: boolean
        default: false
      upload_linux_x64_appimage:
        description: 'ä¸Šä¼  Linux x64 AppImage'
        required: false
        type: boolean
        default: false
      # Linux ARM64 åŒ…
      upload_linux_arm64_deb:
        description: 'ä¸Šä¼  Linux ARM64 DEB'
        required: false
        type: boolean
        default: false
      upload_linux_arm64_rpm:
        description: 'ä¸Šä¼  Linux ARM64 RPM'
        required: false
        type: boolean
        default: false
      upload_linux_arm64_appimage:
        description: 'ä¸Šä¼  Linux ARM64 AppImage'
        required: false
        type: boolean
        default: false
      # å…¶ä»–é€‰é¡¹
      update_release_notes:
        description: 'æ›´æ–° Release è¯´æ˜ï¼ˆæ·»åŠ  R2 ä¸‹è½½é“¾æ¥ï¼‰'
        required: false
        type: boolean
        default: true
      update_readme:
        description: 'æ›´æ–° README.mdï¼ˆæ·»åŠ  R2 é•œåƒé“¾æ¥ï¼‰'
        required: false
        type: boolean
        default: true

  # æ”¯æŒè¢«å…¶ä»– workflow è°ƒç”¨
  workflow_call:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š1.0.0ï¼Œä¸éœ€è¦ v å‰ç¼€ï¼‰'
        required: true
        type: string
      # macOS åŒ…
      upload_macos_arm64:
        description: 'ä¸Šä¼  macOS ARM64 DMG'
        required: false
        type: boolean
        default: true
      upload_macos_x64:
        description: 'ä¸Šä¼  macOS x64 DMG'
        required: false
        type: boolean
        default: false
      # Windows åŒ…
      upload_windows_x64_msi:
        description: 'ä¸Šä¼  Windows x64 MSI'
        required: false
        type: boolean
        default: true
      upload_windows_x64_nsis:
        description: 'ä¸Šä¼  Windows x64 NSIS'
        required: false
        type: boolean
        default: false
      upload_windows_x86_msi:
        description: 'ä¸Šä¼  Windows x86 MSI'
        required: false
        type: boolean
        default: false
      upload_windows_x86_nsis:
        description: 'ä¸Šä¼  Windows x86 NSIS'
        required: false
        type: boolean
        default: false
      # Linux x64 åŒ…
      upload_linux_x64_deb:
        description: 'ä¸Šä¼  Linux x64 DEB'
        required: false
        type: boolean
        default: false
      upload_linux_x64_rpm:
        description: 'ä¸Šä¼  Linux x64 RPM'
        required: false
        type: boolean
        default: false
      upload_linux_x64_appimage:
        description: 'ä¸Šä¼  Linux x64 AppImage'
        required: false
        type: boolean
        default: false
      # Linux ARM64 åŒ…
      upload_linux_arm64_deb:
        description: 'ä¸Šä¼  Linux ARM64 DEB'
        required: false
        type: boolean
        default: false
      upload_linux_arm64_rpm:
        description: 'ä¸Šä¼  Linux ARM64 RPM'
        required: false
        type: boolean
        default: false
      upload_linux_arm64_appimage:
        description: 'ä¸Šä¼  Linux ARM64 AppImage'
        required: false
        type: boolean
        default: false
      # å…¶ä»–é€‰é¡¹
      update_release_notes:
        description: 'æ›´æ–° Release è¯´æ˜ï¼ˆæ·»åŠ  R2 ä¸‹è½½é“¾æ¥ï¼‰'
        required: false
        type: boolean
        default: true
      update_readme:
        description: 'æ›´æ–° README.mdï¼ˆæ·»åŠ  R2 é•œåƒé“¾æ¥ï¼‰'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify AWS CLI
        run: |
          echo "ğŸ“¦ Verifying AWS CLI installation..."
          aws --version
          echo "âœ… AWS CLI is ready"

      - name: Configure AWS CLI for Cloudflare R2
        run: |
          echo "ğŸ”§ Configuring AWS CLI for Cloudflare R2..."
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set default.region auto
          echo "âœ… AWS CLI configured"

      - name: Download release assets
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading release assets from GitHub Release..."
          VERSION="${{ inputs.version }}"

          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p ./r2-upload
          cd ./r2-upload

          # macOS åŒ…
          if [[ "${{ inputs.upload_macos_arm64 }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading macOS ARM64 DMG..."
            gh release download "v${VERSION}" \
              --pattern "*aarch64*.dmg" \
              --repo ${{ github.repository }} || echo "âš ï¸ macOS ARM64 DMG not found"
          fi

          if [[ "${{ inputs.upload_macos_x64 }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading macOS x64 DMG..."
            gh release download "v${VERSION}" \
              --pattern "*x64*.dmg" \
              --repo ${{ github.repository }} || echo "âš ï¸ macOS x64 DMG not found"
          fi

          # Windows x64 åŒ…
          if [[ "${{ inputs.upload_windows_x64_msi }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Windows x64 MSI..."
            gh release download "v${VERSION}" \
              --pattern "*x64*.msi" \
              --repo ${{ github.repository }} || echo "âš ï¸ Windows x64 MSI not found"
          fi

          if [[ "${{ inputs.upload_windows_x64_nsis }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Windows x64 NSIS..."
            gh release download "v${VERSION}" \
              --pattern "*x64*.exe" \
              --repo ${{ github.repository }} || echo "âš ï¸ Windows x64 NSIS not found"
          fi

          # Windows x86 åŒ…
          if [[ "${{ inputs.upload_windows_x86_msi }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Windows x86 MSI..."
            gh release download "v${VERSION}" \
              --pattern "*x86*.msi" \
              --repo ${{ github.repository }} || echo "âš ï¸ Windows x86 MSI not found"
          fi

          if [[ "${{ inputs.upload_windows_x86_nsis }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Windows x86 NSIS..."
            gh release download "v${VERSION}" \
              --pattern "*x86*.exe" \
              --repo ${{ github.repository }} || echo "âš ï¸ Windows x86 NSIS not found"
          fi

          # Linux x64 åŒ…
          if [[ "${{ inputs.upload_linux_x64_deb }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Linux x64 DEB..."
            gh release download "v${VERSION}" \
              --pattern "*amd64*.deb" \
              --repo ${{ github.repository }} || echo "âš ï¸ Linux x64 DEB not found"
          fi

          if [[ "${{ inputs.upload_linux_x64_rpm }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Linux x64 RPM..."
            gh release download "v${VERSION}" \
              --pattern "*x86_64*.rpm" \
              --repo ${{ github.repository }} || echo "âš ï¸ Linux x64 RPM not found"
          fi

          if [[ "${{ inputs.upload_linux_x64_appimage }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Linux x64 AppImage..."
            gh release download "v${VERSION}" \
              --pattern "*amd64*.AppImage" \
              --repo ${{ github.repository }} || echo "âš ï¸ Linux x64 AppImage not found"
          fi

          # Linux ARM64 åŒ…
          if [[ "${{ inputs.upload_linux_arm64_deb }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Linux ARM64 DEB..."
            gh release download "v${VERSION}" \
              --pattern "*arm64*.deb" \
              --repo ${{ github.repository }} || echo "âš ï¸ Linux ARM64 DEB not found"
          fi

          if [[ "${{ inputs.upload_linux_arm64_rpm }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Linux ARM64 RPM..."
            gh release download "v${VERSION}" \
              --pattern "*aarch64*.rpm" \
              --repo ${{ github.repository }} || echo "âš ï¸ Linux ARM64 RPM not found"
          fi

          if [[ "${{ inputs.upload_linux_arm64_appimage }}" == "true" ]]; then
            echo "ğŸ“¦ Downloading Linux ARM64 AppImage..."
            gh release download "v${VERSION}" \
              --pattern "*arm64*.AppImage" \
              --repo ${{ github.repository }} || echo "âš ï¸ Linux ARM64 AppImage not found"
          fi

          # åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
          echo "ğŸ“‹ Downloaded files:"
          ls -lh

          cd ..

      - name: Upload to Cloudflare R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "â˜ï¸ Uploading files to Cloudflare R2..."
          VERSION="${{ inputs.version }}"

          # è°ƒè¯•ä¿¡æ¯
          echo "ğŸ“‹ Debug info:"
          echo "   R2_ENDPOINT: ${R2_ENDPOINT}"
          echo "   R2_BUCKET: ${R2_BUCKET}"
          echo "   VERSION: ${VERSION}"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ 
          if [ -z "$(ls -A ./r2-upload 2>/dev/null)" ]; then
            echo "âš ï¸ No files to upload"
            echo "ğŸ“‚ Listing r2-upload directory:"
            ls -la ./r2-upload 2>/dev/null || echo "   Directory does not exist or is empty"
            exit 0
          fi

          echo "ğŸ“‚ Files to upload:"
          ls -la ./r2-upload/

          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶åˆ° R2
          UPLOAD_COUNT=0
          FAILED_COUNT=0
          for file in ./r2-upload/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              echo "ğŸ“¤ Uploading: $filename ($filesize)"

              # ä¸Šä¼ åˆ° R2ï¼Œè·¯å¾„æ ¼å¼: releases/v{version}/{filename}
              # æ³¨æ„ï¼šCloudflare R2 ä¸æ”¯æŒ ACLï¼Œç§»é™¤ --acl å‚æ•°
              if aws s3 cp "$file" \
                "s3://${R2_BUCKET}/releases/v${VERSION}/${filename}" \
                --endpoint-url "${R2_ENDPOINT}"; then
                echo "âœ… Successfully uploaded: $filename"
                UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
              else
                echo "âŒ Failed to upload: $filename"
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
            fi
          done

          echo "ğŸ‰ Upload completed! Total files uploaded: $UPLOAD_COUNT, Failed: $FAILED_COUNT"

          # å¦‚æœæœ‰å¤±è´¥çš„ä¸Šä¼ ï¼Œè¾“å‡ºè­¦å‘Šä½†ä¸å¤±è´¥æ•´ä¸ª job
          if [ $FAILED_COUNT -gt 0 ]; then
            echo "âš ï¸ Some files failed to upload. Please check the logs above."
          fi

      - name: Generate download URLs
        if: inputs.update_release_notes == true
        env:
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”— Generating download URLs..."
          VERSION="${{ inputs.version }}"

          # è°ƒè¯•ä¿¡æ¯
          echo "ğŸ“‹ Debug info:"
          echo "   R2_PUBLIC_URL: ${R2_PUBLIC_URL}"
          echo "   R2_BUCKET: ${R2_BUCKET}"
          echo "   VERSION: ${VERSION}"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          if [ -z "$(ls -A ./r2-upload 2>/dev/null)" ]; then
            echo "âš ï¸ No files to generate URLs for"
            exit 0
          fi

          # æ„å»ºåŸºç¡€ URL - ç¡®ä¿æ ¼å¼æ­£ç¡®
          if [ -n "${R2_PUBLIC_URL}" ]; then
            # ç§»é™¤å¯èƒ½çš„å°¾éƒ¨æ–œæ 
            R2_PUBLIC_URL="${R2_PUBLIC_URL%/}"
            # ç¡®ä¿ URL åŒ…å«åè®®å‰ç¼€
            if [[ "${R2_PUBLIC_URL}" =~ ^https?:// ]]; then
              base_url="${R2_PUBLIC_URL}"
            else
              base_url="https://${R2_PUBLIC_URL}"
            fi
          else
            base_url="https://${R2_BUCKET}.r2.dev"
          fi

          echo "ğŸ“‹ Base URL: ${base_url}"

          echo "## Cloudflare R2 ä¸‹è½½é“¾æ¥ï¼ˆå›½å†…è®¿é—®ä¼˜åŒ–ï¼‰" > r2-urls.md
          echo "" >> r2-urls.md
          echo "ä»¥ä¸‹æ–‡ä»¶å·²ä¸Šä¼ åˆ° Cloudflare R2ï¼Œæä¾›æ›´å¿«çš„å›½å†…è®¿é—®é€Ÿåº¦ï¼š" >> r2-urls.md
          echo "" >> r2-urls.md

          for file in ./r2-upload/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              url="${base_url}/releases/v${VERSION}/${filename}"

              echo "ğŸ“ Generated URL: ${url}"
              echo "- **${filename}** (${filesize}): [ä¸‹è½½é“¾æ¥](${url})" >> r2-urls.md
            fi
          done

          echo "" >> r2-urls.md
          echo "---" >> r2-urls.md
          echo "" >> r2-urls.md

          echo "ğŸ“„ Generated r2-urls.md content:"
          cat r2-urls.md

          # è·å–å½“å‰ Release è¯´æ˜
          CURRENT_NOTES=$(gh release view "v${VERSION}" --json body -q .body --repo ${{ github.repository }})

          # æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å« R2 é“¾æ¥
          if echo "$CURRENT_NOTES" | grep -q "Cloudflare R2"; then
            echo "âš ï¸ Release notes already contain R2 links, skipping update"
          else
            # å°† R2 é“¾æ¥è¿½åŠ åˆ°ç°æœ‰è¯´æ˜
            {
              echo "$CURRENT_NOTES"
              echo ""
              cat r2-urls.md
            } > combined-notes.md

            # æ›´æ–° Release è¯´æ˜
            gh release edit "v${VERSION}" \
              --notes-file combined-notes.md \
              --repo ${{ github.repository }}

            echo "âœ… Release notes updated with R2 download links"
          fi

      - name: Update README with R2 mirror links
        if: inputs.update_readme == true
        env:
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "ğŸ“ Updating README.md with R2 mirror links..."
          VERSION="${{ inputs.version }}"

          # è°ƒè¯•ä¿¡æ¯
          echo "ğŸ“‹ Debug info:"
          echo "   R2_PUBLIC_URL: ${R2_PUBLIC_URL}"
          echo "   R2_BUCKET: ${R2_BUCKET}"
          echo "   VERSION: ${VERSION}"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          if [ -z "$(ls -A ./r2-upload 2>/dev/null)" ]; then
            echo "âš ï¸ No files to update in README"
            exit 0
          fi

          # æ£€æŸ¥ README.md æ˜¯å¦å­˜åœ¨
          if [ ! -f "README.md" ]; then
            echo "âš ï¸ README.md not found, skipping update"
            exit 0
          fi

          # æ„å»ºåŸºç¡€ URL - ç¡®ä¿æ ¼å¼æ­£ç¡®
          if [ -n "${R2_PUBLIC_URL}" ]; then
            # ç§»é™¤å¯èƒ½çš„å°¾éƒ¨æ–œæ 
            R2_PUBLIC_URL="${R2_PUBLIC_URL%/}"
            # ç¡®ä¿ URL åŒ…å«åè®®å‰ç¼€
            if [[ "${R2_PUBLIC_URL}" =~ ^https?:// ]]; then
              base_url="${R2_PUBLIC_URL}"
            else
              base_url="https://${R2_PUBLIC_URL}"
            fi
          else
            base_url="https://${R2_BUCKET}.r2.dev"
          fi

          echo "ğŸ“‹ Base URL for README: ${base_url}"

          # å¤‡ä»½ README
          cp README.md README.md.backup

          # æ³¨æ„ï¼šREADME æ›´æ–°åŠŸèƒ½æš‚æ—¶ç¦ç”¨ï¼Œå› ä¸º sed æ›¿æ¢å¯èƒ½å¯¼è‡´æ ¼å¼é—®é¢˜
          # å¦‚æœéœ€è¦åœ¨ README ä¸­æ·»åŠ å›½å†…é•œåƒé“¾æ¥ï¼Œå»ºè®®æ‰‹åŠ¨æ›´æ–°
          echo "â„¹ï¸ README update is currently disabled to prevent formatting issues."
          echo "â„¹ï¸ R2 download links are available in the Release notes."
          echo "â„¹ï¸ If you want to add mirror links to README, please update manually."

          # åˆ—å‡ºç”Ÿæˆçš„ R2 é“¾æ¥ä¾›å‚è€ƒ
          echo ""
          echo "ğŸ“‹ Generated R2 download links for reference:"
          for file in ./r2-upload/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              r2_url="${base_url}/releases/v${VERSION}/${filename}"
              echo "   ${filename}: ${r2_url}"
            fi
          done

          echo "âœ… README update step completed (no changes made)"

      - name: Commit and push README changes
        if: inputs.update_release_notes == true
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet README.md; then
            echo "â„¹ï¸ No changes to README.md"
          else
            git add README.md
            git commit -m "docs: update download links to v${{ inputs.version }}"
            git push
            echo "âœ… README.md changes committed and pushed"
          fi

