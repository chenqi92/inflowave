name: Auto Release on Version Change

on:
  push:
    branches: [ main, master ]
    paths:
      - 'package.json'
      - 'src-tauri/tauri.conf.json'
      - 'src-tauri/Cargo.toml'
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force create release even if version unchanged'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  # æ£€æŸ¥ç‰ˆæœ¬å˜åŒ–çš„å·¥ä½œ
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      has_changed: ${{ steps.version.outputs.has_changed }}
      prev_version: ${{ steps.version.outputs.prev_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check version changes
        id: version
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬
          current_version=$(node -p "require('./package.json').version")
          echo "current_version=$current_version" >> $GITHUB_OUTPUT
          echo "version=$current_version" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç‰ˆæœ¬æ ‡ç­¾
          if git tag -l | grep -q "v$current_version"; then
            echo "Tag v$current_version already exists"
            
            # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬
            prev_version=$(git tag -l "v*" | sort -V | tail -n 1 | sed 's/^v//')
            echo "prev_version=$prev_version" >> $GITHUB_OUTPUT
            
            if [ "${{ github.event.inputs.force_release }}" = "true" ]; then
              echo "Force release enabled"
              echo "has_changed=true" >> $GITHUB_OUTPUT
            else
              echo "Version unchanged and force_release not enabled"
              echo "has_changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "New version detected: $current_version"
            
            # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
            prev_version=$(git tag -l "v*" | sort -V | tail -n 1 | sed 's/^v//' || echo "0.0.0")
            echo "prev_version=$prev_version" >> $GITHUB_OUTPUT
            
            echo "has_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Run version consistency check
        run: |
          echo "ğŸ” Running version consistency check..."
          npm run version:check
          
          if [ $? -ne 0 ]; then
            echo "âŒ Version consistency check failed"
            echo "ğŸ”„ Attempting to sync versions..."
            npm run version:sync
            
            # å¦‚æœç‰ˆæœ¬åŒæ­¥åæœ‰å˜åŒ–ï¼Œæäº¤æ›´æ”¹
            if [ -n "$(git status --porcelain)" ]; then
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"
              git add -A
              git commit -m "chore: sync version across all configuration files"
              git push
            fi
          fi

  # å…¨å¹³å°æ„å»ºå·¥ä½œ
  build-all-platforms:
    needs: check-version
    if: needs.check-version.outputs.has_changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows æ„å»º
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            arch: 'x64'
            os: 'windows'
          - platform: 'windows-latest'
            target: 'i686-pc-windows-msvc'
            arch: 'x86'
            os: 'windows'
          
          # macOS æ„å»º
          - platform: 'macos-latest'
            target: 'x86_64-apple-darwin'
            arch: 'x64'
            os: 'macos'
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            arch: 'arm64'
            os: 'macos'
          - platform: 'macos-latest'
            target: 'universal-apple-darwin'
            arch: 'universal'
            os: 'macos'
          
          # Linux æ„å»º
          - platform: 'ubuntu-22.04'
            target: 'x86_64-unknown-linux-gnu'
            arch: 'x64'
            os: 'linux'
          - platform: 'ubuntu-22.04'
            target: 'aarch64-unknown-linux-gnu'
            arch: 'arm64'
            os: 'linux'
          - platform: 'ubuntu-22.04'
            target: 'i686-unknown-linux-gnu'
            arch: 'x86'
            os: 'linux'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Linux only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Install additional dependencies for cross-compilation (Linux ARM64)
        if: matrix.platform == 'ubuntu-22.04' && matrix.arch == 'arm64'
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++" >> $GITHUB_ENV

      - name: Install additional dependencies for cross-compilation (Linux x86)
        if: matrix.platform == 'ubuntu-22.04' && matrix.arch == 'x86'
        run: |
          sudo apt-get install -y gcc-multilib g++-multilib
          sudo apt-get install -y libwebkit2gtk-4.1-dev:i386 libgtk-3-dev:i386 || true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup additional macOS targets
        if: matrix.platform == 'macos-latest'
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Standard Mode
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENABLE_EMBEDDED_SERVER: false
        with:
          tagName: v${{ needs.check-version.outputs.version }}
          releaseName: 'InfloWave v${{ needs.check-version.outputs.version }}'
          releaseBody: |
            ## ğŸš€ InfloWave v${{ needs.check-version.outputs.version }}
            
            ### ğŸ“‹ æ›´æ–°å†…å®¹
            
            ç‰ˆæœ¬ä» `${{ needs.check-version.outputs.prev_version }}` æ›´æ–°åˆ° `${{ needs.check-version.outputs.version }}`
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            #### ğŸ–¥ï¸ **Standard Mode (æ¨è)**
            - **Windows**: `InfloWave_*_x64-setup.exe` (64ä½) / `InfloWave_*_x86-setup.exe` (32ä½)
            - **macOS**: `InfloWave_*_universal.dmg` (é€šç”¨ç‰ˆæœ¬ï¼Œæ”¯æŒ Intel å’Œ Apple Silicon)
            - **Linux**: `inflowave_*_amd64.deb` / `inflowave_*_amd64.AppImage` (64ä½)
            
            #### ğŸŒ **Server Mode (é«˜çº§åŠŸèƒ½)**
            - åŒ…å«å†…ç½® HTTP æœåŠ¡å™¨
            - æ”¯æŒ API é›†æˆå’Œè°ƒè¯•å·¥å…·
            - æ–‡ä»¶ååŒ…å« `-server` åç¼€
            
            ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
            
            **Standard Mode**:
            - âœ… é›¶ç«¯å£å†²çª - ä½¿ç”¨ IPC é€šä¿¡
            - âœ… æœ€ä½³æ€§èƒ½ - åŸç”Ÿé€šä¿¡
            - âœ… å¢å¼ºå®‰å…¨æ€§ - æ— ç½‘ç»œæš´éœ²
            - âœ… æ›´å°ä½“ç§¯ - æœ€å°ä¾èµ–
            
            **Server Mode**:
            - âœ… æ™ºèƒ½ç«¯å£ç®¡ç† - è‡ªåŠ¨è§£å†³å†²çª (1422-1500)
            - âœ… HTTP API æ”¯æŒ - RESTful æ¥å£
            - âœ… CORS ä»£ç† - è·¨åŸŸè¯·æ±‚æ”¯æŒ
            - âœ… è°ƒè¯•å·¥å…· - å¼€å‘å®ç”¨ç¨‹åº
            - âœ… WebSocket æ”¯æŒ - å®æ—¶é€šä¿¡
            
            ### ğŸ¯ å¹³å°æ”¯æŒ
            
            | å¹³å° | æ¶æ„ | çŠ¶æ€ |
            |------|------|------|
            | Windows | x64, x86 | âœ… |
            | macOS | Intel, Apple Silicon, Universal | âœ… |
            | Linux | x64, ARM64, x86 | âœ… |
            
            ---
            
            **å®‰è£…æç¤º**: 
            - Windows ç”¨æˆ·å»ºè®®ä¸‹è½½ `x64` ç‰ˆæœ¬
            - macOS ç”¨æˆ·å»ºè®®ä¸‹è½½ `universal` ç‰ˆæœ¬
            - Linux ç”¨æˆ·å¯é€‰æ‹© `.deb` æˆ– `.AppImage` æ ¼å¼
            
            å¦‚é‡åˆ°é—®é¢˜è¯·æŸ¥çœ‹ [æ•…éšœæ’é™¤æŒ‡å—](https://github.com/chenqi92/inflowave/blob/main/docs/troubleshooting.md) æˆ–æäº¤ [Issue](https://github.com/chenqi92/inflowave/issues)ã€‚
          releaseDraft: false
          prerelease: false
          includeRelease: true
          includeUpdaterJson: true
          args: --target ${{ matrix.target }}

      - name: Build Server Mode
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENABLE_EMBEDDED_SERVER: true
        with:
          tagName: v${{ needs.check-version.outputs.version }}-server
          releaseName: 'InfloWave v${{ needs.check-version.outputs.version }} (Server Mode)'
          releaseBody: |
            ## ğŸŒ InfloWave v${{ needs.check-version.outputs.version }} - Server Mode
            
            ### å¢å¼ºç‰ˆæœ¬ - åŒ…å« HTTP æœåŠ¡å™¨
            
            æ­¤ç‰ˆæœ¬åŒ…å«å®Œæ•´çš„ HTTP æœåŠ¡å™¨åŠŸèƒ½ï¼Œé€‚åˆéœ€è¦ API é›†æˆå’Œé«˜çº§åŠŸèƒ½çš„ç”¨æˆ·ã€‚
            
            ### ğŸš€ æœåŠ¡å™¨æ¨¡å¼ç‰¹æ€§
            
            - **ğŸ”Œ æ™ºèƒ½ç«¯å£ç®¡ç†**: è‡ªåŠ¨æ£€æµ‹å’Œè§£å†³ç«¯å£å†²çª (1422-1500)
            - **ğŸŒ HTTP API**: å®Œæ•´çš„ RESTful API æ”¯æŒ
            - **ğŸ”„ CORS ä»£ç†**: è·¨åŸŸè¯·æ±‚ä»£ç†åŠŸèƒ½
            - **ğŸ› ï¸ è°ƒè¯•å·¥å…·**: å†…ç½®å¼€å‘è°ƒè¯•å·¥å…·
            - **ğŸ“¡ WebSocket**: å®æ—¶åŒå‘é€šä¿¡æ”¯æŒ
            - **ğŸ“Š å®æ—¶ç›‘æ§**: æœåŠ¡å™¨çŠ¶æ€å®æ—¶ç›‘æ§
            
            ### ğŸ’¡ ä½¿ç”¨åœºæ™¯
            
            - éœ€è¦é€šè¿‡ HTTP API é›†æˆå…¶ä»–ç³»ç»Ÿ
            - éœ€è¦è·¨åŸŸæ•°æ®è®¿é—®
            - å¼€å‘å’Œè°ƒè¯• InfluxDB åº”ç”¨
            - éœ€è¦ WebSocket å®æ—¶æ•°æ®æ¨é€
            
            ### ğŸ“¥ ä¸‹è½½æ–‡ä»¶
            
            æœåŠ¡å™¨æ¨¡å¼çš„å®‰è£…åŒ…æ–‡ä»¶ååŒ…å« `-server` åç¼€ï¼Œè¯·æ ¹æ®æ‚¨çš„å¹³å°é€‰æ‹©ï¼š
            
            | å¹³å° | æ¨èç‰ˆæœ¬ | æ–‡ä»¶åæ¨¡å¼ |
            |------|----------|------------|
            | Windows | 64ä½ | `*-server*_x64-setup.exe` |
            | macOS | é€šç”¨ç‰ˆ | `*-server*_universal.dmg` |
            | Linux | 64ä½ | `*-server*_amd64.deb` |
            
            ---
            
            **ğŸ“Œ æ³¨æ„**: æœåŠ¡å™¨æ¨¡å¼ä¼šå ç”¨ç½‘ç»œç«¯å£ï¼Œè¯·ç¡®ä¿é˜²ç«å¢™è®¾ç½®å…è®¸åº”ç”¨è®¿é—®ç½‘ç»œã€‚
          releaseDraft: false
          prerelease: false
          includeRelease: true
          includeUpdaterJson: true
          args: --target ${{ matrix.target }}

  # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
  create-version-tag:
    needs: [check-version, build-all-platforms]
    if: needs.check-version.outputs.has_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create and push version tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
          git tag -a "v${{ needs.check-version.outputs.version }}" -m "Release v${{ needs.check-version.outputs.version }}"
          
          # æ¨é€æ ‡ç­¾
          git push origin "v${{ needs.check-version.outputs.version }}"
          
          echo "âœ… Created and pushed tag: v${{ needs.check-version.outputs.version }}"

  # å‘å¸ƒåé€šçŸ¥
  post-release:
    needs: [check-version, build-all-platforms, create-version-tag]
    if: needs.check-version.outputs.has_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Release Summary
        run: |
          echo "ğŸ‰ Release v${{ needs.check-version.outputs.version }} created successfully!"
          echo ""
          echo "ğŸ“¦ Built for platforms:"
          echo "  - Windows (x64, x86)"
          echo "  - macOS (Intel, Apple Silicon, Universal)"
          echo "  - Linux (x64, ARM64, x86)"
          echo ""
          echo "ğŸš€ Available modes:"
          echo "  - Standard Mode (Pure Tauri)"
          echo "  - Server Mode (HTTP Server included)"
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.check-version.outputs.version }}"