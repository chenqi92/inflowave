name: Dual Mode Build

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v1.0.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub release'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-standard:
    name: Build Standard Mode
    strategy:
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin --target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: '--target x86_64-unknown-linux-gnu'
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev \
            pkg-config libglib2.0-dev libgdk-pixbuf2.0-dev libpango1.0-dev libatk1.0-dev libgtk-3-dev \
            libxdo-dev libxdo3

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || matrix.platform == 'ubuntu-22.04' && 'x86_64-unknown-linux-gnu' || '' }}

      - name: Install additional Rust targets
        run: |
          if [ "${{ matrix.platform }}" = "macos-latest" ]; then
            rustup target add aarch64-apple-darwin
            rustup target add x86_64-apple-darwin
          elif [ "${{ matrix.platform }}" = "ubuntu-22.04" ]; then
            rustup target add x86_64-unknown-linux-gnu
          fi

      - uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - run: npm ci

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENABLE_EMBEDDED_SERVER: false
          DISABLE_CONSOLE_LOGS: true
          # è·¨ç¼–è¯‘ç¯å¢ƒå˜é‡
          PKG_CONFIG_ALLOW_CROSS: 1
          PKG_CONFIG_PATH: ${{ matrix.platform == 'ubuntu-22.04' && '/usr/lib/pkgconfig:/usr/share/pkgconfig' || '' }}
          # ä¿®å¤ macOS universal build é—®é¢˜
          MACOSX_DEPLOYMENT_TARGET: ${{ matrix.platform == 'macos-latest' && '10.13' || '' }}
        with:
          tagName: ${{ inputs.tag_name }}
          releaseName: 'InfloWave ${{ inputs.tag_name }} (Standard)'
          releaseBody: |
            ## ğŸš€ InfloWave v__VERSION__
            
            ç°ä»£åŒ–çš„æ—¶åºæ•°æ®åº“ç®¡ç†å·¥å…·ï¼Œæä¾›ç›´è§‚çš„ç”¨æˆ·ç•Œé¢å’Œå¼ºå¤§çš„æ•°æ®åˆ†æåŠŸèƒ½ã€‚
            
            ### âœ¨ ä¸»è¦ç‰¹æ€§
            - ğŸ”’ **å®‰å…¨ç¨³å®š** - é‡‡ç”¨ IPC é€šä¿¡ï¼Œæ— ç«¯å£å†²çªé£é™©
            - âš¡ **æ€§èƒ½ä¼˜å¼‚** - åŸç”Ÿé€šä¿¡æœºåˆ¶ï¼Œå“åº”é€Ÿåº¦æ›´å¿«
            - ğŸ›¡ï¸ **éšç§ä¿æŠ¤** - ä¸æš´éœ²ç½‘ç»œç«¯å£ï¼Œæ•°æ®æ›´å®‰å…¨
            - ğŸ“¦ **ä½“ç§¯ç²¾ç®€** - æœ€å°åŒ–ä¾èµ–ï¼Œå®‰è£…åŒ…æ›´å°
            
            ### ğŸ’» æ”¯æŒå¹³å°
            
            #### Windows ç”¨æˆ·
            ğŸ“¥ **æ¨èä¸‹è½½ .msi å®‰è£…åŒ…**  
            - é€‚ç”¨äº Windows 10/11 (64ä½ç³»ç»Ÿæ¨è)  
            - åŒå‡»å®‰è£…ï¼Œç®€å•å¿«æ·  
            
            #### macOS ç”¨æˆ·
            ğŸ **Apple Silicon Mac (M1/M2/M3èŠ¯ç‰‡)**  
            ğŸ“¥ **é€‰æ‹© aarch64 ç‰ˆæœ¬**  
            - é€‚ç”¨äº2020å¹´åå‘å¸ƒçš„ Mac (è‹¹æœèŠ¯ç‰‡)  
            - âš ï¸ **æ— æ³•åœ¨ Intel Mac ä¸Šè¿è¡Œ**  
            
            ğŸ’» **Intel Mac**  
            ğŸ“¥ **é€‰æ‹© x64 ç‰ˆæœ¬**  
            - é€‚ç”¨äº2020å¹´å‰çš„ Intel å¤„ç†å™¨ Mac  
            
            #### Linux ç”¨æˆ·
            ğŸ“¦ **Debian/Ubuntu**: é€‰æ‹© .deb å®‰è£…åŒ…  
            ğŸ—‚ï¸ **å…¶ä»–å‘è¡Œç‰ˆ**: é€‰æ‹© .AppImage å…å®‰è£…ç‰ˆæœ¬  
            
            ### ğŸ“ å®‰è£…è¯´æ˜
            1. **Windows**: ä¸‹è½½ .msi æ–‡ä»¶ååŒå‡»å®‰è£…
            2. **macOS**: ä¸‹è½½ .dmg æ–‡ä»¶ï¼ŒåŒå‡»æ‰“å¼€åæ‹–å…¥ Applications æ–‡ä»¶å¤¹
            3. **Linux**: ä¸‹è½½ .deb æˆ– .AppImage æ–‡ä»¶è¿›è¡Œå®‰è£…æˆ–è¿è¡Œ
          releaseDraft: ${{ inputs.create_release }}
          prerelease: false
          includeRelease: ${{ inputs.create_release }}
          args: ${{ matrix.args }}

