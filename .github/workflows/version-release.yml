name: Version-based Release

on:
  push:
    branches: [ main, master ]
    paths:
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  # ç‰ˆæœ¬æ£€æµ‹å·¥ä½œ
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
      tag_exists: ${{ steps.check.outputs.tag_exists }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if version should trigger release
        id: check
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯package.jsonå˜æ›´è§¦å‘çš„
          if [ "${{ github.event_name }}" = "push" ]; then
            # æ£€æŸ¥package.jsonæ˜¯å¦åœ¨æœ¬æ¬¡æäº¤ä¸­è¢«ä¿®æ”¹
            if git diff --name-only HEAD~1 HEAD | grep -q "package.json"; then
              echo "ğŸ“ package.json was modified in this commit"
              
              # æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦çœŸçš„å˜æ›´äº†
              PREV_VERSION=$(git show HEAD~1:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version" || echo "0.0.0")
              echo "Previous version: $PREV_VERSION"
              echo "Current version: $VERSION"
              
              if [ "$VERSION" != "$PREV_VERSION" ]; then
                echo "âœ… Version changed from $PREV_VERSION to $VERSION"
                
                # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
                if git tag -l | grep -q "^v$VERSION$"; then
                  echo "tag_exists=true" >> $GITHUB_OUTPUT
                  echo "should_release=false" >> $GITHUB_OUTPUT
                  echo "âš ï¸ Tag v$VERSION already exists, skipping release"
                else
                  echo "tag_exists=false" >> $GITHUB_OUTPUT
                  echo "should_release=true" >> $GITHUB_OUTPUT
                  echo "ğŸš€ Will create release for v$VERSION"
                fi
              else
                echo "should_release=false" >> $GITHUB_OUTPUT
                echo "â­ï¸ Version unchanged, skipping release"
              fi
            else
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ package.json not modified, skipping release"
            fi
          else
            # æ‰‹åŠ¨è§¦å‘çš„æƒ…å†µ
            if git tag -l | grep -q "^v$VERSION$"; then
              echo "tag_exists=true" >> $GITHUB_OUTPUT
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ Tag v$VERSION already exists, skipping release"
            else
              echo "tag_exists=false" >> $GITHUB_OUTPUT
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "âœ… Manual trigger: will create release for v$VERSION"
            fi
          fi

  # å…¨å¹³å°å…¨æ¶æ„æ„å»º
  build-release:
    needs: detect-version
    if: needs.detect-version.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            arch: 'x64'
            rust_target: 'x86_64-pc-windows-msvc'
          - platform: 'windows-latest'
            target: 'i686-pc-windows-msvc'
            arch: 'x86'
            rust_target: 'i686-pc-windows-msvc'
          
          # macOS - ç§»é™¤ä¸æ”¯æŒçš„ universal-apple-darwin
          - platform: 'macos-latest'
            target: 'x86_64-apple-darwin'
            arch: 'x64'
            rust_target: 'x86_64-apple-darwin'
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            arch: 'arm64'
            rust_target: 'aarch64-apple-darwin'
          
          # Linux - æš‚æ—¶ç§»é™¤æœ‰é—®é¢˜çš„ i686 ç›®æ ‡
          - platform: 'ubuntu-22.04'
            target: 'x86_64-unknown-linux-gnu'
            arch: 'x64'
            rust_target: 'x86_64-unknown-linux-gnu'
          - platform: 'ubuntu-22.04'
            target: 'aarch64-unknown-linux-gnu'
            arch: 'arm64'
            rust_target: 'aarch64-unknown-linux-gnu'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev \
            pkg-config libglib2.0-dev libgdk-pixbuf2.0-dev libpango1.0-dev libatk1.0-dev \
            libxdo-dev libxdo3

      - name: Install cross-compilation dependencies (Linux ARM64)
        if: matrix.platform == 'ubuntu-22.04' && matrix.arch == 'arm64'
        run: |
          # Add ARM64 architecture and update sources
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          
          # Install cross-compilation toolchain
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu pkg-config
          
          # Install ARM64 libraries
          sudo apt-get install -y \
            libglib2.0-dev:arm64 libgtk-3-dev:arm64 libwebkit2gtk-4.1-dev:arm64 \
            libayatana-appindicator3-dev:arm64 librsvg2-dev:arm64 \
            libgdk-pixbuf2.0-dev:arm64 libpango1.0-dev:arm64 libatk1.0-dev:arm64 \
            libxdo-dev:arm64 libxdo3:arm64
          
          # Set cross-compilation environment variables
          echo "CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++" >> $GITHUB_ENV
          echo "AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar" >> $GITHUB_ENV
          echo "STRIP_aarch64_unknown_linux_gnu=aarch64-linux-gnu-strip" >> $GITHUB_ENV
          echo "PKG_CONFIG_aarch64_unknown_linux_gnu=aarch64-linux-gnu-pkg-config" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
          echo "PKG_CONFIG_SYSROOT_DIR=/" >> $GITHUB_ENV

      - name: Install cross-compilation dependencies (Linux x86)
        if: matrix.platform == 'ubuntu-22.04' && matrix.arch == 'x86'
        run: |
          sudo apt-get install -y gcc-multilib g++-multilib \
            libglib2.0-dev:i386 libgtk-3-dev:i386 pkg-config
          # è®¾ç½®32ä½åº“è·¯å¾„
          echo "PKG_CONFIG_PATH=/usr/lib/i386-linux-gnu/pkgconfig:/usr/share/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Setup additional macOS targets
        if: matrix.platform == 'macos-latest'
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Standard Mode
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENABLE_EMBEDDED_SERVER: false
          # è·¨ç¼–è¯‘ç¯å¢ƒå˜é‡
          PKG_CONFIG_ALLOW_CROSS: 1
          PKG_CONFIG_PATH: ${{ matrix.platform == 'ubuntu-22.04' && (matrix.arch == 'arm64' && '/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig' || '/usr/lib/pkgconfig:/usr/share/pkgconfig') || '' }}
          PKG_CONFIG_SYSROOT_DIR: ${{ matrix.platform == 'ubuntu-22.04' && matrix.arch == 'arm64' && '/' || '' }}
          MACOSX_DEPLOYMENT_TARGET: ${{ matrix.platform == 'macos-latest' && '10.13' || '' }}
        with:
          tagName: v${{ needs.detect-version.outputs.version }}
          releaseName: 'InfloWave v${{ needs.detect-version.outputs.version }}'
          releaseBody: |
            ## ğŸš€ InfloWave v${{ needs.detect-version.outputs.version }}
            
            ç°ä»£åŒ–çš„æ—¶åºæ•°æ®åº“ç®¡ç†å·¥å…·ï¼Œæä¾›ç›´è§‚çš„ç”¨æˆ·ç•Œé¢å’Œå¼ºå¤§çš„æ•°æ®åˆ†æåŠŸèƒ½ã€‚
            
            ### âœ¨ ä¸»è¦ç‰¹æ€§
            - ğŸ”’ **å®‰å…¨ç¨³å®š** - é‡‡ç”¨ IPC é€šä¿¡ï¼Œæ— ç«¯å£å†²çªé£é™©
            - âš¡ **æ€§èƒ½ä¼˜å¼‚** - åŸç”Ÿé€šä¿¡æœºåˆ¶ï¼Œå“åº”é€Ÿåº¦æ›´å¿«
            - ğŸ›¡ï¸ **éšç§ä¿æŠ¤** - ä¸æš´éœ²ç½‘ç»œç«¯å£ï¼Œæ•°æ®æ›´å®‰å…¨
            - ğŸ“¦ **ä½“ç§¯ç²¾ç®€** - æœ€å°åŒ–ä¾èµ–ï¼Œå®‰è£…åŒ…æ›´å°
            
            ### ğŸ’» æ”¯æŒå¹³å°
            
            #### Windows ç”¨æˆ·
            ğŸ“¥ **[InfloWave_v${{ needs.detect-version.outputs.version }}_x64.msi](https://github.com/${{ github.repository }}/releases/download/v${{ needs.detect-version.outputs.version }}/InfloWave_v${{ needs.detect-version.outputs.version }}_x64.msi)**  
            - é€‚ç”¨äº Windows 10/11 (64ä½ç³»ç»Ÿ)  
            - æ¨èç»™å¤§éƒ¨åˆ†ç”¨æˆ·  
            
            ğŸ“¥ **[InfloWave_v${{ needs.detect-version.outputs.version }}_x86.msi](https://github.com/${{ github.repository }}/releases/download/v${{ needs.detect-version.outputs.version }}/InfloWave_v${{ needs.detect-version.outputs.version }}_x86.msi)**  
            - é€‚ç”¨äºè¾ƒè€çš„32ä½ Windows ç³»ç»Ÿ  
            
            #### macOS ç”¨æˆ·
            ğŸ **Apple Silicon Mac (M1/M2/M3èŠ¯ç‰‡)**  
            ğŸ“¥ **[InfloWave_aarch64.app.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.detect-version.outputs.version }}/InfloWave_aarch64.app.tar.gz)**  
            - é€‚ç”¨äº2020å¹´åå‘å¸ƒçš„ Mac (è‹¹æœèŠ¯ç‰‡)  
            - æ€§èƒ½æœ€ä¼˜ï¼ŒåŸç”Ÿæ”¯æŒ  
            - âš ï¸ **æ— æ³•åœ¨ Intel Mac ä¸Šè¿è¡Œ**  
            
            ğŸ’» **Intel Mac**  
            ğŸ“¥ **[InfloWave_x64.app.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.detect-version.outputs.version }}/InfloWave_x64.app.tar.gz)**  
            - é€‚ç”¨äº2020å¹´å‰çš„ Intel å¤„ç†å™¨ Mac  
            - ä¸æ”¯æŒ Apple Silicon èŠ¯ç‰‡  
            
            #### Linux ç”¨æˆ·
            ğŸ“¦ **Debian/Ubuntu ç³»åˆ—**  
            ğŸ“¥ **[inflowav_${{ needs.detect-version.outputs.version }}_amd64.deb](https://github.com/${{ github.repository }}/releases/download/v${{ needs.detect-version.outputs.version }}/inflowav_${{ needs.detect-version.outputs.version }}_amd64.deb)**  
            - ä½¿ç”¨ `sudo dpkg -i` å‘½ä»¤å®‰è£…  
            
            ğŸ—‚ï¸ **é€šç”¨ Linux**  
            ğŸ“¥ **[InfloWave_${{ needs.detect-version.outputs.version }}_amd64.AppImage](https://github.com/${{ github.repository }}/releases/download/v${{ needs.detect-version.outputs.version }}/InfloWave_${{ needs.detect-version.outputs.version }}_amd64.AppImage)**  
            - å…å®‰è£…ï¼Œä¸‹è½½åç›´æ¥è¿è¡Œ  
            - é€‚ç”¨äºå¤§éƒ¨åˆ† Linux å‘è¡Œç‰ˆ  
            
            ğŸ”§ **ARM64 Linux (æ ‘è“æ´¾ç­‰)**  
            ğŸ“¥ **[InfloWave_${{ needs.detect-version.outputs.version }}_arm64.AppImage](https://github.com/${{ github.repository }}/releases/download/v${{ needs.detect-version.outputs.version }}/InfloWave_${{ needs.detect-version.outputs.version }}_arm64.AppImage)**  
            - æ”¯æŒ ARM64 æ¶æ„çš„ Linux è®¾å¤‡  
            
            ### ğŸ“ å®‰è£…è¯´æ˜
            1. **Windows**: ä¸‹è½½ .msi æ–‡ä»¶ååŒå‡»å®‰è£…
            2. **macOS**: ä¸‹è½½ .tar.gz æ–‡ä»¶ï¼Œè§£å‹åæ‹–å…¥ Applications æ–‡ä»¶å¤¹
            3. **Linux**: ä¸‹è½½ .deb æˆ– .AppImage æ–‡ä»¶ï¼ŒæŒ‰ç…§ä¸Šè¿°è¯´æ˜æ“ä½œ
          releaseDraft: false
          prerelease: false
          args: --target ${{ matrix.rust_target }}

