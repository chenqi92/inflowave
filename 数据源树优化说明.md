# 数据源树展示优化说明

## 🎯 优化目标

1. **收缩按钮显示逻辑优化**：未连接状态的数据源不显示收缩按钮，只有连接状态才显示
2. **局部刷新优化**：连接或断开数据源时，只刷新变更状态的数据源节点，而不是整个树

## 🔧 实现的优化

### 1. 收缩按钮显示逻辑优化

**修改文件**：`src/components/layout/DatabaseExplorer.tsx`

#### 修改点 1：连接节点初始化逻辑
**位置**：第 412-433 行
**原始代码**：
```typescript
const connectionNode: DataNode = {
  // ... 其他属性
  children: [],
};
```

**优化后代码**：
```typescript
const connectionNode: DataNode = {
  // ... 其他属性
  // 只有连接状态才设置children数组，未连接状态不设置（这样就不会显示收缩按钮）
  ...(isConnected ? { children: [] } : { isLeaf: true }),
};
```

**优化效果**：
- 未连接状态：设置 `isLeaf: true`，不显示收缩按钮
- 已连接状态：设置 `children: []`，显示收缩按钮

#### 修改点 2：连接状态更新时的显示逻辑
**位置**：第 1348-1382 行
**原始代码**：
```typescript
return {
  ...node,
  title: (/* ... */),
  icon: isConnected ? (/* ... */) : (/* ... */),
};
```

**优化后代码**：
```typescript
const updatedNode = {
  ...node,
  title: (/* ... */),
  icon: isConnected ? (/* ... */) : (/* ... */),
  // 根据连接状态决定是否显示收缩按钮
  ...(isConnected ? { children: node.children || [] } : { isLeaf: true }),
};

// 如果从连接状态变为未连接状态，移除 children 属性
if (!isConnected && updatedNode.children) {
  const { children, ...nodeWithoutChildren } = updatedNode;
  return nodeWithoutChildren;
}

return updatedNode;
```

**优化效果**：
- 动态根据连接状态调整收缩按钮显示
- 断开连接时移除 `children` 属性，隐藏收缩按钮

#### 修改点 3：断开连接时的节点清理
**位置**：第 1500-1512 行
**原始代码**：
```typescript
return {
  ...node,
  children: [],
  isLeaf: false,
};
```

**优化后代码**：
```typescript
const { children, isLeaf, ...nodeWithoutChildren } = node;
return {
  ...nodeWithoutChildren,
  // 断开连接后，移除 children 属性并设置为叶子节点，这样就不会显示收缩按钮
  isLeaf: true,
};
```

**优化效果**：
- 断开连接后完全移除 `children` 属性
- 设置 `isLeaf: true`，确保不显示收缩按钮

### 2. 局部刷新优化

**现有机制**：项目中已经实现了良好的局部刷新机制

#### 现有的局部刷新功能：
1. **连接状态变更监听**：通过 `useEffect` 监听连接状态变化（第 1398-1438 行）
2. **单节点更新**：`updateConnectionNodeDisplay` 函数只更新特定连接节点
3. **数据库节点动态加载**：`addDatabaseNodesToConnection` 函数为特定连接添加数据库子节点
4. **节点清理**：`clearDatabaseNodesForConnection` 函数清理特定连接的子节点
5. **防抖机制**：使用 `setTimeout` 防止频繁更新

#### 局部刷新的实现流程：
1. 连接状态变更 → 触发 `handleConnectionToggle`
2. 立即更新显示状态 → 调用 `updateConnectionNodeDisplay`
3. 异步处理连接结果 → 根据结果调用 `addDatabaseNodesToConnection` 或 `clearDatabaseNodesForConnection`
4. 只更新目标连接节点，不影响其他节点

## 🎨 Tree 组件的收缩按钮显示逻辑

**文件**：`src/components/ui/Tree.tsx`

**关键逻辑**：
```typescript
const hasChildren = 
  (node.children && node.children.length > 0) ||
  (!node.isLeaf && node.children !== undefined);
```

**显示规则**：
- 有 `children` 属性且不为空 → 显示收缩按钮
- 没有 `children` 属性但 `isLeaf` 为 `false` → 显示收缩按钮
- `isLeaf` 为 `true` → 不显示收缩按钮

## ✅ 优化效果

### 1. 收缩按钮显示优化
- **未连接状态**：数据源节点不显示收缩按钮，界面更清爽
- **已连接状态**：数据源节点显示收缩按钮，可以展开查看数据库
- **状态切换**：连接/断开时收缩按钮动态显示/隐藏

### 2. 局部刷新优化
- **精确更新**：只更新变更状态的数据源节点
- **性能提升**：避免整个树的重新渲染
- **用户体验**：展开状态和滚动位置得到保持
- **防抖优化**：避免频繁的状态更新

## 🔍 技术细节

### DataNode 接口设计
```typescript
interface DataNode {
  key: string;
  title: React.ReactNode;
  children?: DataNode[];  // 可选，决定是否显示收缩按钮
  icon?: React.ReactNode;
  isLeaf?: boolean;       // 叶子节点标识
  // ... 其他属性
}
```

### 状态管理策略
- **连接状态**：通过 `isConnectionConnected` 判断
- **节点状态**：通过 `children` 和 `isLeaf` 属性控制显示
- **加载状态**：通过 `connectionLoadingStates` 管理

### 性能优化点
1. **避免全量重建**：使用 `setTreeData` 的函数式更新
2. **精确节点匹配**：通过 `node.key` 精确匹配需要更新的节点
3. **防抖机制**：使用 `setTimeout` 防止频繁更新
4. **状态缓存**：使用 `useRef` 缓存上次状态，避免不必要的更新

## 📈 预期改进

1. **界面体验**：未连接数据源界面更简洁，减少用户困惑
2. **交互流畅**：连接状态切换时界面响应更快
3. **性能提升**：减少不必要的渲染，提高大量数据源场景下的性能
4. **状态保持**：用户的展开状态和滚动位置得到更好的保持